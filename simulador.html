<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Network Budget Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #f7fafc;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .heading-primary {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .form-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
         .form-section:first-of-type {
             border-top: none;
             margin-top: 0;
             padding-top: 0;
         }
        .section-heading {
            font-size: 1.5rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: #334155;
            margin-bottom: 0.5rem;
        }
        .form-input, .form-select {
            display: block;
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            color: #4b5563;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvgxmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='none' stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }
         .action-button {
             color: white;
             font-weight: 600;
             padding: 0.625rem 1.25rem;
             border-radius: 0.375rem;
             transition: background-color 0.15s ease-in-out;
             margin-top: 1rem;
             border: none;
             cursor: pointer;
         }
         .add-button { background-color: #10b981; }
         .add-button:hover { background-color: #059669; }
         .update-button { background-color: #3b82f6; }
         .update-button:hover { background-color: #2563eb; }
         .cancel-button { background-color: #6b7280; }
         .cancel-button:hover { background-color: #4b5563; }

        .table-container {
            overflow-x: auto;
            margin-top: 3rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .table-header th {
            background-color: #f0f4f8;
            color: #334155;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }
        .table-body td {
            padding: 1rem;
            color: #4b5563;
            border-bottom: 1px solid #f2f2f2;
        }
        .table-body tr:last-child td { border-bottom: none; }
        .table-body tr:hover { background-color: #f7fafc; }
        .action-icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
        }
        .delete-button { color: #dc2626; }
        .delete-button:hover { color: #b91c1c; background-color: #fee2e2; }
        .edit-button { color: #2563eb; }
        .edit-button:hover { color: #1d4ed8; background-color: #dbeafe; }

        .total-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #eff6ff;
            border-radius: 0.5rem;
            border: 1px solid #e0f2fe;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-label { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .total-value { font-size: 1.25rem; color: #15803d; font-weight: 700; }
        .message-container {
            margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem;
            background-color: #f0fdf4; border: 1px solid #d1fae5;
            color: #065f46; font-weight: 500; text-align: center;
        }
        .canvas-wrapper {
            overflow-x: auto; margin-top: 0.5rem; border: 1px solid #e5e7eb;
            border-radius: 0.5rem; background-color: #ffffff;
        }
        #ramal-canvas { display: block; min-width: 100%; height: 600px; }
         .form-row {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
             gap: 1.5rem;
         }
         .form-row > .form-group { margin-bottom: 0; }
        .icon-button {
            background-color: #e5e7eb; color: #4b5563;
            padding: 0.5rem; border-radius: 9999px;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            border: none; cursor: pointer; line-height: 0;
        }
        .icon-button:hover { background-color: #d1d5db; color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="container">
        <h1 class="heading-primary">Electrical Network Budget Simulator</h1>

        <div class="form-section">
            <h2 class="section-heading">Step 1: Project Information</h2>
            <div class="form-group">
                <label for="projeto" class="form-label">PROJECT NAME:</label>
                <input type="text" id="projeto" name="projeto" class="form-input" placeholder="Ex: Residential Installation">
            </div>
             <div class="form-group">
                <label for="autor" class="form-label">AUTHOR:</label>
                <input type="text" id="autor" name="autor" class="form-input" placeholder="Your Name">
            </div>
            <div class="form-group">
                <label for="regiao" class="form-label">REGION:</label>
                <select id="regiao" name="regiao" class="form-select">
                    <option value="" disabled selected>Select Region</option>
                    <option value="LAR">LAR</option>
                    <option value="EMEA">EMEA</option>
                    <option value="NAR">NAR</option>
                    <option value="ASIA">ASIA</option>
                </select>
            </div>
        </div>

        <div id="main-wire-form-section" class="form-section item-form-section"> <h2 class="section-heading">Step 2: MAIN WIRE</h2>
             <div class="form-row">
                <div class="form-group">
                    <label for="main-wire-length" class="form-label">TOTAL LENGTH (meters):</label>
                    <input type="number" id="main-wire-length" name="main-wire-length" class="form-input" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="main-wire-amount" class="form-label">WIRE AMOUNT:</label>
                    <input type="number" id="main-wire-amount" name="main-wire-amount" class="form-input" value="1" min="1">
                </div>
             </div>
             <div class="form-row">
                <div class="form-group">
                    <label for="main-wire-insulation" class="form-label">INSULATION:</label>
                    <select id="main-wire-insulation" name="main-wire-insulation" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label for="main-wire-gauge" class="form-label">GAUGE (AWG):</label>
                    <select id="main-wire-gauge" name="main-wire-gauge" class="form-select"></select>
                </div>
             </div>
            <div class="form-group custom-main-wire-fields hidden">
                <label for="custom-main-wire-insulation-name" class="form-label">Custom Insulation Name:</label>
                <input type="text" id="custom-main-wire-insulation-name" name="custom-main-wire-insulation-name" class="form-input" placeholder="Ex: XLPE">
            </div>
            <div class="form-group custom-main-wire-fields hidden">
                <label for="custom-main-wire-gauge-input" class="form-label">Custom Gauge (AWG):</label>
                <input type="text" id="custom-main-wire-gauge-input" name="custom-main-wire-gauge-input" class="form-input" placeholder="Ex: 16.0">
            </div>
            <div class="form-group custom-main-wire-fields hidden">
                <label for="custom-main-wire-price-per-meter" class="form-label">Custom Price per Meter ($):</label>
                <input type="number" id="custom-main-wire-price-per-meter" name="custom-main-wire-price-per-meter" class="form-input" value="0" min="0" step="0.001">
            </div>
            <div class="form-group">
                <label for="main-wire-number" class="form-label">WIRE NUMBER:</label>
                <input type="text" id="main-wire-number" name="main-wire-number" class="form-input" placeholder="Ex: W01">
            </div>
            <div id="main-wire-actions">
                <button id="adicionar-main-wire" class="action-button add-button">Add Main Wire</button>
            </div>
        </div>

        <div id="secondary-wire-form-section" class="form-section item-form-section"> <h2 class="section-heading">Step 3: SECONDARY WIRE</h2>
             <div class="form-row">
                <div class="form-group">
                    <label for="secondary-wire-length" class="form-label">TOTAL LENGTH (meters):</label>
                    <input type="number" id="secondary-wire-length" name="secondary-wire-length" class="form-input" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="secondary-wire-amount" class="form-label">WIRE AMOUNT:</label>
                    <input type="number" id="secondary-wire-amount" name="secondary-wire-amount" class="form-input" value="1" min="1">
                </div>
             </div>
             <div class="form-row">
                <div class="form-group">
                    <label for="secondary-wire-insulation" class="form-label">INSULATION:</label>
                    <select id="secondary-wire-insulation" name="secondary-wire-insulation" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label for="secondary-wire-gauge" class="form-label">GAUGE (AWG):</label>
                    <select id="secondary-wire-gauge" name="secondary-wire-gauge" class="form-select"></select>
                </div>
            </div>
            <div class="form-group custom-secondary-wire-fields hidden">
                <label for="custom-secondary-wire-insulation-name" class="form-label">Custom Insulation Name:</label>
                <input type="text" id="custom-secondary-wire-insulation-name" name="custom-secondary-wire-insulation-name" class="form-input" placeholder="Ex: EPR">
            </div>
            <div class="form-group custom-secondary-wire-fields hidden">
                <label for="custom-secondary-wire-gauge-input" class="form-label">Custom Gauge (AWG):</label>
                <input type="text" id="custom-secondary-wire-gauge-input" name="custom-secondary-wire-gauge-input" class="form-input" placeholder="Ex: 0.8">
            </div>
            <div class="form-group custom-secondary-wire-fields hidden">
                <label for="custom-secondary-wire-price-per-meter" class="form-label">Custom Price per Meter ($):</label>
                <input type="number" id="custom-secondary-wire-price-per-meter" name="custom-secondary-wire-price-per-meter" class="form-input" value="0" min="0" step="0.001">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="secondary-wire-number" class="form-label">WIRE NUMBER:</label>
                    <input type="text" id="secondary-wire-number" name="secondary-wire-number" class="form-input" placeholder="Ex: W02">
                </div>
                <div class="form-group">
                    <label for="secondary-wire-integration-wire" class="form-label">WIRE INTEGRATION:</label>
                    <select id="secondary-wire-integration-wire" name="secondary-wire-integration-wire" class="form-select"></select>
                </div>
            </div>
             <div class="form-group">
                <label for="secondary-wire-integration-distance" class="form-label">INTEGRATION DISTANCE (m):</label>
                <input type="number" id="secondary-wire-integration-distance" name="secondary-wire-integration-distance" class="form-input" value="0" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Branch Direction:</label>
                <div class="flex items-center space-x-6 py-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" id="direction-below" name="branch-direction" value="below" class="form-radio h-4 w-4 text-blue-600" checked>
                        <span>Below Main Wire</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" id="direction-above" name="branch-direction" value="above" class="form-radio h-4 w-4 text-blue-600">
                        <span>Above Main Wire</span>
                    </label>
                </div>
            </div>
            <div id="secondary-wire-actions">
                <button id="adicionar-secondary-wire" class="action-button add-button">Add Secondary Wire</button>
            </div>
        </div>

        <div id="component-form-section" class="form-section item-form-section"> <h2 class="section-heading">Step 4: COMPONENTS</h2>
             <div class="form-row">
                <div class="form-group">
                    <label for="component-type" class="form-label">COMPONENT TYPE:</label>
                    <select id="component-type" name="component-type" class="form-select"></select>
                </div>
                 <div class="form-group">
                    <label for="component-model" class="form-label">MODEL:</label>
                    <select id="component-model" name="component-model" class="form-select" disabled></select>
                </div>
            </div>
            <div class="form-group custom-component-fields hidden">
                <label for="custom-component-name" class="form-label">Custom Name:</label>
                <input type="text" id="custom-component-name" class="form-input" placeholder="Ex: Xtreme Component">
            </div>
            <div class="form-group custom-component-fields hidden">
                <label for="custom-component-price" class="form-label">Custom Unit Price ($):</label>
                <input type="number" id="custom-component-price" name="custom-component-price" class="form-input" value="0" min="0" step="0.01">
            </div>
            <div class="form-row">
                 <div class="form-group">
                    <label for="component-wire" class="form-label">WIRE:</label>
                    <select id="component-wire" name="component-wire" class="form-select"></select>
                </div>
                 <div class="form-group">
                    <label for="component-distance" class="form-label">DISTANCE (m):</label>
                    <input type="number" id="component-distance" name="component-distance" class="form-input" value="0" min="0">
                </div>
            </div>
             <div class="form-group">
                <label for="component-quantity" class="form-label">QUANTITY:</label>
                <input type="number" id="component-quantity" name="component-quantity" class="form-input" value="1" min="1">
            </div>
            <div id="component-actions">
                <button id="adicionar-componente" class="action-button add-button">Add Component</button>
                <button id="repeat-component" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last Component</button>
            </div>
        </div>

        <div id="connector-form-section" class="form-section item-form-section"> <h2 class="section-heading">Step 5: CONNECTOR</h2>
             <div class="form-row">
                <div class="form-group">
                    <label for="connector-model" class="form-label">MODEL:</label>
                    <select id="connector-model" name="connector-model" class="form-select"></select>
                </div>
                 <div class="form-group">
                    <label for="connector-wire" class="form-label">WIRE:</label>
                    <select id="connector-wire" name="connector-wire" class="form-select"></select>
                </div>
            </div>
            <div class="form-group custom-connector-fields hidden">
                <label for="custom-connector-name" class="form-label">Custom Name:</label>
                <input type="text" id="custom-connector-name" name="custom-connector-name" class="form-input" placeholder="Ex: Ultra Connector">
            </div>
            <div class="form-group custom-connector-fields hidden">
                <label for="custom-connector-price" class="form-label">Custom Unit Price ($):</label>
                <input type="number" id="custom-connector-price" name="custom-connector-price" class="form-input" value="0" min="0" step="0.01">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="connector-distance" class="form-label">DISTANCE (m):</label>
                    <input type="number" id="connector-distance" name="connector-distance" class="form-input" value="0" min="0">
                </div>
                 <div class="form-group">
                    <label for="connector-quantity" class="form-label">QUANTITY:</label>
                    <input type="number" id="connector-quantity" name="connector-quantity" class="form-input" value="1" min="1">
                </div>
            </div>
            <div id="connector-actions">
                <button id="adicionar-conector" class="action-button add-button">Add Connector</button>
                <button id="repeat-connector" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last Connector</button>
            </div>
        </div>

        <div class="table-container">
             <table class="table">
                <thead class="table-header">
                    <tr>
                        <th>#</th>
                        <th>Type</th>
                        <th>Source Wire</th>
                        <th>Item / Model / Gauge</th>
                        <th>Qty. / Length</th>
                        <th>Distance</th>
                        <th>Unit Price ($)</th>
                        <th>Subtotal ($)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lista-itens" class="table-body">
                    <tr><td colspan="9" class="text-center text-gray-500">No items added.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="total-section">
            <span class="total-label">Total Estimate:</span>
            <span id="total-estimativa" class="total-value">$ 0.000</span>
        </div>
        
        <div class="form-section">
            <div class="flex justify-between items-center">
                <h2 class="section-heading" style="margin-bottom: 0;">Wire View</h2>
                <div class="flex items-center space-x-2">
                    <button id="zoom-out-button" class="icon-button" title="Zoom Out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                    </button>
                    <button id="zoom-in-button" class="icon-button" title="Zoom In">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                    </button>
                </div>
            </div>
            <div class="canvas-wrapper">
                <canvas id="ramal-canvas"></canvas>
            </div>
        </div>

        <div class="flex justify-center mt-6">
            <button id="export-pdf-button" class="action-button bg-purple-600 hover:bg-purple-700">
                Export to PDF
            </button>
        </div>

        <div id="mensagem-container" class="message-container" style="display: none;"></div>
    </div>

    <script>
        // --- Sample Data (Simulating Database) ---
        const insulationOptions = ["PVC", "Other"];
        const gaugeOptions = ["24", "22", "20", "18", "17", "16"];
        const componentTypesData = [ { type: "Bimetal", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.800 }, { type: "Ferrite", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.800 }, { type: "Splice", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.060 }, { type: "POLYAMIDE GLUE", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.154 }, { type: "HEAT SHRINK TUBE", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.240 }, { type: "Hot Melt", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.010 }, { type: "Terminal", isDirectPrice: false, models: [ {"model": "39012065", "unit": "Unit", "pricePerUnit": 0.03820}, {"model": "39012125", "unit": "Unit", "pricePerUnit": 0.07185}, {"model": "39013028", "unit": "Unit", "pricePerUnit": 0.07100}, {"model": "39013029", "unit": "Unit", "pricePerUnit": 0.03158}, {"model": "39014053", "unit": "Unit", "pricePerUnit": 0.10800}, {"model": "50841025", "unit": "Unit", "pricePerUnit": 0.07607}, {"model": "50841035", "unit": "Unit", "pricePerUnit": 0.08588}, {"model": "50841045", "unit": "Unit", "pricePerUnit": 0.09588}, {"model": "50842032", "unit": "Unit", "pricePerUnit": 0.10789}, {"model": "50842042", "unit": "Unit", "pricePerUnit": 0.11489}, {"model": "366440004", "unit": "Unit", "pricePerUnit": 0.11789}, {"model": "433351002", "unit": "Unit", "pricePerUnit": 0.06359}, {"model": "457763006", "unit": "Unit", "pricePerUnit": 0.24687}, {"model": "457763012", "unit": "Unit", "pricePerUnit": 0.30191}, {"model": "945504106", "unit": "Unit", "pricePerUnit": 0.09123}, {"model": "1-1744417-0", "unit": "Unit", "pricePerUnit": 0.03921}, {"model": "1-1971772-4", "unit": "Unit", "pricePerUnit": 0.06804}, {"model": "1-1971773-2", "unit": "Unit", "pricePerUnit": 0.04276}, {"model": "1-1971775-3", "unit": "Unit", "pricePerUnit": 0.21512}, {"model": "1-1971776-3", "unit": "Unit", "pricePerUnit": 0.22795}, {"model": "17444036-3", "unit": "Unit", "pricePerUnit": 0.03140}, {"model": "17444036-5", "unit": "Unit", "pricePerUnit": 0.04041}, {"model": "1744417-4", "unit": "Unit", "pricePerUnit": 0.01469}, {"model": "1744417-5", "unit": "Unit", "pricePerUnit": 0.02298}, {"model": "1744417-7", "unit": "Unit", "pricePerUnit": 0.02497}, {"model": "1969588-4", "unit": "Unit", "pricePerUnit": 0.01000}, {"model": "2371377-9", "unit": "Unit", "pricePerUnit": 0.05000}, {"model": "316088-1", "unit": "Unit", "pricePerUnit": 0.04565}, {"model": "4-180923-0", "unit": "Unit", "pricePerUnit": 0.04801}, {"model": "521229-1", "unit": "Unit", "pricePerUnit": 0.03464}, {"model": "PARP-04V", "unit": "Unit", "pricePerUnit": 0.01430}, {"model": "VLR-02", "unit": "Unit", "pricePerUnit": 0.04890}, {"model": "VLR-03V", "unit": "Unit", "pricePerUnit": 0.07460}, {"model": "XARP-04V", "unit": "Unit", "pricePerUnit": 0.01950}, {"model": "YLNR-02VF", "unit": "Unit", "pricePerUnit": 0.03920}, {"model": "YLP-03V", "unit": "Unit", "pricePerUnit": 0.02890}, {"model": "W11669793", "unit": "Unit", "pricePerUnit": 0.0520}, {"model": "W11678929", "unit": "Unit", "pricePerUnit": 0.1620} ]}, { type: "Tape", isDirectPrice: false, models: [ { model: "Masking Tape", unit: "Meter", pricePerUnit: 0.10 }, { model: "Electrical Tape", unit: "Roll", pricePerUnit: 2.50 }, { model: "GLASS TAPE", unit: "Meter", "pricePerUnit": 0.30 } ]}, { type: "Ground Ring", isDirectPrice: false, models: [ { model: "61795-3", unit: "Unit", pricePerUnit: 0.12345 } ]}, { type: "Retainer", isDirectPrice: false, models: [ { model: "1-1969443-0", "unit": "Unit", pricePerUnit: 0.01000 }, { "model": "316088-1", "unit": "Unit", "pricePerUnit": 0.04565 }, { "model": "YLS-03V", "unit": "Unit", "pricePerUnit": 0.02890 } ]}, { type: "Grommet", isDirectPrice: false, models: [ { model: "12.5mm", unit: "Unit", pricePerUnit: 0.05 }, { model: "19mm", unit: "Unit", pricePerUnit: 0.06 }, { model: "30mm", unit: "Unit", pricePerUnit: 0.08 } ]} ];
        const connectorModelsData = [ {"model": "39012065", "unit": "Unit", "pricePerUnit": 0.03820}, {"model": "39012125", "unit": "Unit", "pricePerUnit": 0.07185}, {"model": "39013028", "unit": "Unit", "pricePerUnit": 0.07100}, {"model": "39013029", "unit": "Unit", "pricePerUnit": 0.03158}, {"model": "39014053", "unit": "Unit", "pricePerUnit": 0.10800}, {"model": "50841025", "unit": "Unit", "pricePerUnit": 0.07607}, {"model": "50841035", "unit": "Unit", "pricePerUnit": 0.08588}, {"model": "50841045", "unit": "Unit", "pricePerUnit": 0.09588}, {"model": "50842032", "unit": "Unit", "pricePerUnit": 0.10789}, {"model": "50842042", "unit": "Unit", "pricePerUnit": 0.11489}, {"model": "366440004", "unit": "Unit", "pricePerUnit": 0.11789}, {"model": "433351002", "unit": "Unit", "pricePerUnit": 0.06359}, {"model": "457763006", "unit": "Unit", "pricePerUnit": 0.24687}, {"model": "457763012", "unit": "Unit", "pricePerUnit": 0.30191}, {"model": "945504106", "unit": "Unit", "pricePerUnit": 0.09123}, {"model": "1-1744417-0", "unit": "Unit", "pricePerUnit": 0.03921}, {"model": "1-1971772-4", "unit": "Unit", "pricePerUnit": 0.06804}, {"model": "1-1971773-2", "unit": "Unit", "pricePerUnit": 0.04276}, {"model": "1-1971775-3", "unit": "Unit", "pricePerUnit": 0.21512}, {"model": "1-1971776-3", "unit": "Unit", "pricePerUnit": 0.22795}, {"model": "17444036-3", "unit": "Unit", "pricePerUnit": 0.03140}, {"model": "17444036-5", "unit": "Unit", "pricePerUnit": 0.04041}, {"model": "1744417-4", "unit": "Unit", "pricePerUnit": 0.01469}, {"model": "1744417-5", "unit": "Unit", "pricePerUnit": 0.02298}, {"model": "1744417-7", "unit": "Unit", "pricePerUnit": 0.02497}, {"model": "1969588-4", "unit": "Unit", "pricePerUnit": 0.01000}, {"model": "2371377-9", "unit": "Unit", "pricePerUnit": 0.05000}, {"model": "316088-1", "unit": "Unit", "pricePerUnit": 0.04565}, {"model": "4-180923-0", "unit": "Unit", "pricePerUnit": 0.04801}, {"model": "521229-1", "unit": "Unit", "pricePerUnit": 0.03464}, {"model": "PARP-04V", "unit": "Unit", "pricePerUnit": 0.01430}, {"model": "VLR-02", "unit": "Unit", "pricePerUnit": 0.04890}, {"model": "VLR-03V", "unit": "Unit", "pricePerUnit": 0.07460}, {"model": "XARP-04V", "unit": "Unit", "pricePerUnit": 0.01950}, {"model": "YLNR-02VF", "unit": "Unit", "pricePerUnit": 0.03920}, {"model": "YLP-03V", "unit": "Unit", "pricePerUnit": 0.02890}, {"model": "W11669793", "unit": "Unit", "pricePerUnit": 0.0520}, {"model": "W11678929", "unit": "Unit", "pricePerUnit": 0.1620} ];
        const wirePriceData = [ { gauge: "24", pricePerMeterSingle: 0.05 },{ gauge: "22", pricePerMeterSingle: 0.06 },{ gauge: "20", pricePerMeterSingle: 0.07 },{ gauge: "18", pricePerMeterSingle: 0.08 },{ gauge: "17", pricePerMeterSingle: 0.09 },{ gauge: "16", pricePerMeterSingle: 0.10 }, ];

        // --- DOM Elements ---
        const allDomElements = {
            projetoInput: document.getElementById("projeto"),
            autorInput: document.getElementById("autor"),
            regiaoSelect: document.getElementById("regiao"),
            mainWire: {
                length: document.getElementById("main-wire-length"),
                amount: document.getElementById("main-wire-amount"),
                insulation: document.getElementById("main-wire-insulation"),
                gauge: document.getElementById("main-wire-gauge"),
                customInsulation: document.getElementById("custom-main-wire-insulation-name"),
                customGauge: document.getElementById("custom-main-wire-gauge-input"),
                customPrice: document.getElementById("custom-main-wire-price-per-meter"),
                customFields: document.querySelectorAll(".custom-main-wire-fields"),
                number: document.getElementById("main-wire-number"),
                actions: document.getElementById("main-wire-actions"),
                formSection: document.getElementById("main-wire-form-section")
            },
            secondaryWire: {
                length: document.getElementById("secondary-wire-length"),
                amount: document.getElementById("secondary-wire-amount"),
                insulation: document.getElementById("secondary-wire-insulation"),
                gauge: document.getElementById("secondary-wire-gauge"),
                customInsulation: document.getElementById("custom-secondary-wire-insulation-name"),
                customGauge: document.getElementById("custom-secondary-wire-gauge-input"),
                customPrice: document.getElementById("custom-secondary-wire-price-per-meter"),
                customFields: document.querySelectorAll(".custom-secondary-wire-fields"),
                number: document.getElementById("secondary-wire-number"),
                parent: document.getElementById("secondary-wire-integration-wire"),
                distance: document.getElementById("secondary-wire-integration-distance"),
                actions: document.getElementById("secondary-wire-actions"),
                formSection: document.getElementById("secondary-wire-form-section")
            },
            component: {
                type: document.getElementById("component-type"),
                model: document.getElementById("component-model"),
                customName: document.getElementById("custom-component-name"),
                customPrice: document.getElementById("custom-component-price"),
                customFields: document.querySelectorAll(".custom-component-fields"),
                wire: document.getElementById("component-wire"),
                distance: document.getElementById("component-distance"),
                quantity: document.getElementById("component-quantity"),
                actions: document.getElementById("component-actions"),
                formSection: document.getElementById("component-form-section")
            },
            connector: {
                model: document.getElementById("connector-model"),
                customName: document.getElementById("custom-connector-name"),
                customPrice: document.getElementById("custom-connector-price"),
                customFields: document.querySelectorAll(".custom-connector-fields"),
                wire: document.getElementById("connector-wire"),
                distance: document.getElementById("connector-distance"),
                quantity: document.getElementById("connector-quantity"),
                actions: document.getElementById("connector-actions"),
                formSection: document.getElementById("connector-form-section")
            },
            listaItensBody: document.getElementById("lista-itens"),
            totalEstimativaElement: document.getElementById("total-estimativa"),
            mensagemContainer: document.getElementById("mensagem-container"),
            ramalCanvas: document.getElementById("ramal-canvas"),
            exportPdfButton: document.getElementById("export-pdf-button"),
            zoomInButton: document.getElementById("zoom-in-button"),
            zoomOutButton: document.getElementById("zoom-out-button"),
            repeatComponentButton: document.getElementById("repeat-component"),
            repeatConnectorButton: document.getElementById("repeat-connector")
        };
        const ramalCanvasCtx = allDomElements.ramalCanvas.getContext("2d");

        // --- Application State ---
        let listaItens = [];
        let totalEstimativa = 0;
        let lastAddedComponent = null;
        let lastAddedConnector = null;
        let zoomLevel = 1.0;
        const zoomStep = 0.1;
        let editingIndex = null;
        
        // --- Funções de Limpeza e UI ---
        
        function clearAllForms() {
            // <<< SELETORES ATUALIZADOS AQUI >>>
            // Limpa apenas os campos dentro das seções de formulário de itens.
            const itemFormInputs = document.querySelectorAll('.item-form-section input[type="text"], .item-form-section input[type="number"]');
            const itemFormSelects = document.querySelectorAll('.item-form-section select');

            itemFormInputs.forEach(input => {
                if (input.name.includes('quantity') || input.name.includes('amount')) {
                    input.value = "1";
                } else if (input.type === 'number') {
                    input.value = "0";
                } else {
                    input.value = "";
                }
            });

            itemFormSelects.forEach(select => {
                select.selectedIndex = 0;
                select.dispatchEvent(new Event('change')); // Para resetar campos customizados
            });
        }
        
        // O resto das funções permanece o mesmo...
        // Incluindo todas as funções de adicionar, editar, desenhar, etc.
        const formatCurrency = (value) => `$${(value || 0).toFixed(3)}`;
        
        function exibirMensagem(message, type = "success") {
            const container = allDomElements.mensagemContainer;
            container.textContent = message;
            container.style.display = "block";
            container.className = `message-container ${type === "success" ? 'bg-green-100 border-green-400 text-green-800' : 'bg-red-100 border-red-400 text-red-800'}`;
            setTimeout(() => { container.style.display = "none"; }, 3000);
        }

        function preencherStaticSelects() {
            const { mainWire, secondaryWire, component, connector } = allDomElements;
            
            [mainWire.insulation, secondaryWire.insulation].forEach(select => {
                select.innerHTML = '<option value="" disabled selected>Select Insulation</option>';
                insulationOptions.forEach(item => select.add(new Option(item, item)));
            });

            [mainWire.gauge, secondaryWire.gauge].forEach(select => {
                select.innerHTML = '<option value="" disabled selected>Select Gauge</option>';
                gaugeOptions.forEach(item => select.add(new Option(item, item)));
            });

            component.type.innerHTML = '<option value="" disabled selected>Select Type</option>';
            componentTypesData.forEach(compType => {
                const text = compType.isDirectPrice ? compType.type.toUpperCase() : compType.type;
                component.type.add(new Option(text, compType.type));
            });

            connector.model.innerHTML = '<option value="" disabled selected>Select Model</option>';
            connectorModelsData.forEach(conn => connector.model.add(new Option(conn.model, conn.model)));
            connector.model.add(new Option("Other / Custom", "custom"));
        }
        
        function handleAddItem(type, itemData) {
            listaItens.push(itemData);
            exibirMensagem(`${type} added successfully.`, "success");
            atualizarInterfaceCompleta();
        }

        function handleUpdateItem(type, itemData) {
            listaItens[editingIndex] = itemData;
            exibirMensagem(`${type} updated successfully.`, "success");
            finalizarEdicao();
        }

        function collectAndValidateWireData(wireType) {
            const isMain = wireType === 'main';
            const dom = isMain ? allDomElements.mainWire : allDomElements.secondaryWire;
            
            const length = parseFloat(dom.length.value);
            const amount = parseInt(dom.amount.value);
            let insulation = dom.insulation.value;
            let gauge = dom.gauge.value;
            const wireNumber = dom.number.value.trim();

            let finalInsulationName, finalGauge, finalPricePerMeterSingleWire;

            if (insulation === 'Other') {
                finalInsulationName = dom.customInsulation.value.trim();
                finalGauge = dom.customGauge.value.trim();
                finalPricePerMeterSingleWire = parseFloat(dom.customPrice.value);
                if (!finalInsulationName || !finalGauge || isNaN(finalPricePerMeterSingleWire) || finalPricePerMeterSingleWire <= 0) {
                    exibirMensagem("Please fill all custom Wire fields (Name, Gauge, Price > 0).", "erro");
                    return null;
                }
            } else {
                finalInsulationName = insulation;
                finalGauge = gauge;
                if (!finalInsulationName || !finalGauge) {
                    exibirMensagem("Please select Insulation and Gauge.", "erro");
                    return null;
                }
                const priceData = wirePriceData.find(item => item.gauge === finalGauge);
                finalPricePerMeterSingleWire = priceData ? priceData.pricePerMeterSingle : 0;
            }

            if (length <= 0 || amount <= 0 || !wireNumber) {
                exibirMensagem("Please fill Length, Amount, and Wire Number.", "erro");
                return null;
            }
            if (listaItens.some((item, index) => item.wireNumber === wireNumber && index !== editingIndex)) {
                exibirMensagem(`Wire Number "${wireNumber}" is already in use.`, "erro");
                return null;
            }

            const baseData = { wireNumber, length, amount, insulation: finalInsulationName, gauge: finalGauge, pricePerUnit: finalPricePerMeterSingleWire };

            if (isMain) {
                if (listaItens.some(item => item.type === 'main-wire' && item.wireNumber !== (editingIndex !== null ? listaItens[editingIndex].wireNumber : null))) {
                    exibirMensagem("A Main Wire already exists.", "erro");
                    return null;
                }
                const subtotal = length * finalPricePerMeterSingleWire * amount;
                return { ...baseData, type: 'main-wire', subtotal };
            } else {
                const parentWireNumber = dom.parent.value;
                const integrationDistance = parseFloat(dom.distance.value);
                const direction = document.querySelector('input[name="branch-direction"]:checked').value;

                if (!parentWireNumber || isNaN(integrationDistance) || integrationDistance < 0) {
                    exibirMensagem("Please select a source wire and set a valid integration distance.", "erro");
                    return null;
                }
                const parentWire = listaItens.find(item => item.wireNumber === parentWireNumber);
                if (!parentWire) {
                    exibirMensagem(`Source wire "${parentWireNumber}" not found.`, "erro");
                    return null;
                }
                if (integrationDistance > parentWire.length) {
                    exibirMensagem(`Integration distance exceeds the length of source wire.`, "erro");
                    return null;
                }
                const subtotal = length * finalPricePerMeterSingleWire * amount;
                return { ...baseData, type: 'secondary-wire', parentWireNumber, integrationDistance, direction, subtotal };
            }
        }
        
        function adicionarFioPrincipal() {
            const itemData = collectAndValidateWireData('main');
            if (itemData) handleAddItem("Main Wire", itemData);
        }

        function adicionarFioSecundario() {
            const itemData = collectAndValidateWireData('secondary');
            if (itemData) handleAddItem("Secondary Wire", itemData);
        }
        
        window.iniciarEdicao = (index) => {
            if (editingIndex !== null) {
                exibirMensagem("Please finish the current edit before starting a new one.", "erro");
                return;
            }

            editingIndex = index;
            const item = listaItens[index];

            switch(item.type) {
                case 'main-wire':
                    popularFormularioFio('main', item);
                    configurarBotoesParaEdicao('main-wire');
                    allDomElements.mainWire.formSection.scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'secondary-wire':
                    popularFormularioFio('secondary', item);
                    configurarBotoesParaEdicao('secondary-wire');
                    allDomElements.secondaryWire.formSection.scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'component':
                    popularFormularioComponente(item);
                    configurarBotoesParaEdicao('component');
                    allDomElements.component.formSection.scrollIntoView({ behavior: 'smooth' });
                    break;
                case 'connector':
                    popularFormularioConector(item);
                    configurarBotoesParaEdicao('connector');
                    allDomElements.connector.formSection.scrollIntoView({ behavior: 'smooth' });
                    break;
            }
            exibirMensagem(`Editing Item #${index + 1}.`, "success");
        };

        function popularFormularioFio(wireType, item) {
            const isMain = wireType === 'main';
            const dom = isMain ? allDomElements.mainWire : allDomElements.secondaryWire;

            dom.length.value = item.length;
            dom.amount.value = item.amount;
            dom.number.value = item.wireNumber;

            const isStandardInsulation = insulationOptions.includes(item.insulation);
            dom.insulation.value = isStandardInsulation ? item.insulation : "Other";
            dom.insulation.dispatchEvent(new Event('change'));

            if (!isStandardInsulation) {
                dom.customInsulation.value = item.insulation;
                dom.customGauge.value = item.gauge;
                dom.customPrice.value = item.pricePerUnit;
            } else {
                dom.gauge.value = item.gauge;
            }

            if (!isMain) {
                dom.parent.value = item.parentWireNumber;
                dom.distance.value = item.integrationDistance;
                document.querySelector(`input[name="branch-direction"][value="${item.direction || 'below'}"]`).checked = true;
            }
        }

        function popularFormularioComponente(item) {
            const dom = allDomElements.component;
            dom.type.value = item.itemType;
            dom.type.dispatchEvent(new Event('change'));

            setTimeout(() => { 
                if (item.isCustom) {
                    dom.model.value = "custom";
                    dom.model.dispatchEvent(new Event('change'));
                    dom.customName.value = item.model;
                    dom.customPrice.value = item.pricePerUnit;
                } else {
                    const typeData = componentTypesData.find(t => t.type === item.itemType);
                    if (typeData && !typeData.isDirectPrice) {
                        dom.model.value = item.model;
                    }
                }
                dom.wire.value = item.parentWireNumber;
                dom.distance.value = item.distance;
                dom.quantity.value = item.quantity;
            }, 100);
        }

        function popularFormularioConector(item) {
            const dom = allDomElements.connector;
             if (item.isCustom) {
                dom.model.value = "custom";
                dom.model.dispatchEvent(new Event('change'));
                dom.customName.value = item.model;
                dom.customPrice.value = item.pricePerUnit;
            } else {
                dom.model.value = item.model;
            }
            dom.wire.value = item.parentWireNumber;
            dom.distance.value = item.distance;
            dom.quantity.value = item.quantity;
        }

        function configurarBotoesParaEdicao(type) {
            const sections = {
                'main-wire': allDomElements.mainWire.actions,
                'secondary-wire': allDomElements.secondaryWire.actions,
                'component': allDomElements.component.actions,
                'connector': allDomElements.connector.actions
            };
            
            for (const key in sections) {
                const buttonContainer = sections[key];
                const originalButtons = buttonContainer.innerHTML;
                buttonContainer.dataset.originalHtml = originalButtons;

                if (type === key || type === key.replace('-wire', '')) {
                    buttonContainer.innerHTML = `
                        <button class="action-button update-button">Update ${key.replace('-',' ').toUpperCase()}</button>
                        <button class="action-button cancel-button ml-2">Cancel</button>
                    `;
                    buttonContainer.querySelector('.update-button').addEventListener('click', () => atualizarItem(key));
                    buttonContainer.querySelector('.cancel-button').addEventListener('click', finalizarEdicao);
                } else {
                    Array.from(buttonContainer.children).forEach(btn => btn.disabled = true);
                }
            }
        }
        
        function atualizarItem(type) {
            let itemData;
            switch(type) {
                case 'main-wire': 
                    itemData = collectAndValidateWireData('main'); 
                    if (itemData) handleUpdateItem("Main Wire", itemData);
                    break;
                case 'secondary-wire':
                     itemData = collectAndValidateWireData('secondary');
                     if (itemData) handleUpdateItem("Secondary Wire", itemData);
                     break;
                case 'component':
                     adicionarComponenteItem(true);
                     break;
                case 'connector':
                     adicionarConector(true);
                     break;
            }
        }

        function finalizarEdicao() {
            editingIndex = null;
            clearAllForms();

            allDomElements.mainWire.actions.innerHTML = '<button id="adicionar-main-wire" class="action-button add-button">Add Main Wire</button>';
            allDomElements.mainWire.actions.querySelector('button').addEventListener('click', adicionarFioPrincipal);
            
            allDomElements.secondaryWire.actions.innerHTML = '<button id="adicionar-secondary-wire" class="action-button add-button">Add Secondary Wire</button>';
             allDomElements.secondaryWire.actions.querySelector('button').addEventListener('click', adicionarFioSecundario);

            allDomElements.component.actions.innerHTML = `
                <button id="adicionar-componente" class="action-button add-button">Add Component</button>
                <button id="repeat-component" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last Component</button>`;
            allDomElements.component.actions.querySelector('#adicionar-componente').addEventListener('click', () => adicionarComponenteItem(false));
            allDomElements.component.actions.querySelector('#repeat-component').addEventListener('click', repeatLastComponent);

            allDomElements.connector.actions.innerHTML = `
                <button id="adicionar-conector" class="action-button add-button">Add Connector</button>
                <button id="repeat-connector" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last Connector</button>`;
            allDomElements.connector.actions.querySelector('#adicionar-conector').addEventListener('click', () => adicionarConector(false));
            allDomElements.connector.actions.querySelector('#repeat-connector').addEventListener('click', repeatLastConnector);

            atualizarInterfaceCompleta();
        }
        
        function adicionarComponenteItem(isEditing = false) {
            const { component } = allDomElements;
            const itemType = component.type.value;
            let selectedModel = component.model.value;
            const parentWireNumber = component.wire.value;
            const distance = parseFloat(component.distance.value);
            const quantity = parseInt(component.quantity.value);
            let finalModel, finalPricePerUnit, finalUnit;
            const selectedComponentTypeData = componentTypesData.find(ct => ct.type === itemType);

            if (!selectedComponentTypeData) {
                exibirMensagem("Please select a valid Component Type.", "erro"); return;
            }

            if (selectedComponentTypeData.isDirectPrice) {
                finalModel = selectedComponentTypeData.type;
                finalPricePerUnit = selectedComponentTypeData.pricePerUnit;
                finalUnit = selectedComponentTypeData.unit;
            } else {
                if (selectedModel === 'custom') {
                    finalModel = component.customName.value.trim();
                    finalPricePerUnit = parseFloat(component.customPrice.value);
                    finalUnit = 'Unit';
                    if (!finalModel || isNaN(finalPricePerUnit) || finalPricePerUnit <= 0) {
                        exibirMensagem("Please fill all custom Component fields.", "erro"); return;
                    }
                } else {
                    finalModel = selectedModel;
                    const modelData = selectedComponentTypeData.models?.find(m => m.model === selectedModel);
                    if (!modelData) {
                        exibirMensagem("Select a valid component model.", "erro"); return;
                    }
                    finalPricePerUnit = modelData.pricePerUnit;
                    finalUnit = modelData.unit;
                }
            }

            if (!itemType || !finalModel || !parentWireNumber || isNaN(distance) || distance < 0 || isNaN(quantity) || quantity <= 0) {
                exibirMensagem("Please fill all Component fields correctly.", "erro"); return;
            }

            const parentWire = listaItens.find(item => item.wireNumber === parentWireNumber);
            if (!parentWire) {
                exibirMensagem(`Source wire "${parentWireNumber}" not found.`, "erro"); return;
            }
            if (distance > parentWire.length) {
                exibirMensagem(`Distance exceeds the length of source wire.`, "erro"); return;
            }

            const subtotal = quantity * finalPricePerUnit;
            const novoComponente = { type: 'component', itemType, model: finalModel, parentWireNumber, distance, quantity, unit: finalUnit, pricePerUnit: finalPricePerUnit, subtotal, isCustom: (selectedModel === 'custom') };
            
            if (isEditing) {
                handleUpdateItem("Component", novoComponente);
            } else {
                lastAddedComponent = novoComponente;
                handleAddItem("Component", novoComponente);
            }
        }
        
        function adicionarConector(isEditing = false) {
            const { connector } = allDomElements;
            let selectedModel = connector.model.value;
            const parentWireNumber = connector.wire.value;
            const distance = parseFloat(connector.distance.value);
            const quantity = parseInt(connector.quantity.value);
            let finalModel, finalPricePerUnit, finalUnit;

            if (selectedModel === 'custom') {
                finalModel = connector.customName.value.trim();
                finalPricePerUnit = parseFloat(connector.customPrice.value);
                finalUnit = 'Unit';
                if (!finalModel || isNaN(finalPricePerUnit) || finalPricePerUnit <= 0) {
                    exibirMensagem("Please fill all custom Connector fields.", "erro"); return;
                }
            } else {
                finalModel = selectedModel;
                const modelData = connectorModelsData.find(m => m.model === selectedModel);
                if (!modelData) {
                    exibirMensagem("Select a valid connector model.", "erro"); return;
                }
                finalPricePerUnit = modelData.pricePerUnit;
                finalUnit = modelData.unit;
            }

            if (!finalModel || !parentWireNumber || isNaN(distance) || distance < 0 || isNaN(quantity) || quantity <= 0) {
                exibirMensagem("Please fill all Connector fields correctly.", "erro"); return;
            }

            const parentWire = listaItens.find(item => item.wireNumber === parentWireNumber);
            if (!parentWire) {
                exibirMensagem(`Source wire "${parentWireNumber}" not found.`, "erro"); return;
            }
            if (distance > parentWire.length) {
                exibirMensagem(`Distance exceeds the length of source wire.`, "erro"); return;
            }
            
            const subtotal = quantity * finalPricePerUnit;
            const novoConector = { type: 'connector', model: finalModel, parentWireNumber, distance, quantity, unit: finalUnit, pricePerUnit: finalPricePerUnit, subtotal, isCustom: (selectedModel === 'custom') };
            
            if(isEditing) {
                handleUpdateItem("Connector", novoConector);
            } else {
                lastAddedConnector = novoConector;
                handleAddItem("Connector", novoConector);
            }
        }

        function repeatLastComponent() { if (lastAddedComponent) popularFormularioComponente(lastAddedComponent); else exibirMensagem("No component has been added yet.", "erro"); }
        function repeatLastConnector() { if (lastAddedConnector) popularFormularioConector(lastAddedConnector); else exibirMensagem("No connector has been added yet.", "erro"); }
        
        function atualizarInterfaceCompleta() {
            if (editingIndex === null) {
                // Não chamar clearAllForms aqui para manter os dados
            }
            preencherWireSelects();
            atualizarLista();
            atualizarTotal();
            desenharRede();
        }

        function atualizarLista() {
            const body = allDomElements.listaItensBody;
            if (listaItens.length === 0) {
                body.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">No items added.</td></tr>';
                return;
            }

            body.innerHTML = "";
            listaItens.forEach((item, index) => {
                const row = body.insertRow();
                let desc, qty, wire, dist, price;
                
                switch (item.type) {
                    case 'main-wire': desc = `Main (${item.insulation}, ${item.gauge} AWG) - ${item.wireNumber}`; qty = `${item.length}m (${item.amount} vias)`; wire = '-'; dist = '-'; price = `${formatCurrency(item.pricePerUnit)}/m`; break;
                    case 'secondary-wire': desc = `Sec (${item.insulation}, ${item.gauge} AWG) - ${item.wireNumber}`; qty = `${item.length}m (${item.amount} vias)`; wire = item.parentWireNumber; dist = `${item.integrationDistance}m`; price = `${formatCurrency(item.pricePerUnit)}/m`; break;
                    case 'component': desc = `${item.itemType} - ${item.model}`; qty = `${item.quantity} ${item.unit}`; wire = item.parentWireNumber; dist = `${item.distance}m`; price = `${formatCurrency(item.pricePerUnit)}/${item.unit}`; break;
                    case 'connector': desc = `Connector - ${item.model}`; qty = `${item.quantity} ${item.unit}`; wire = item.parentWireNumber; dist = `${item.distance}m`; price = `${formatCurrency(item.pricePerUnit)}/${item.unit}`; break;
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.type.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase())}</td>
                    <td>${wire}</td>
                    <td>${desc}</td>
                    <td>${qty}</td>
                    <td>${dist}</td>
                    <td>${price}</td>
                    <td>${formatCurrency(item.subtotal)}</td>
                    <td class="flex items-center">
                        <button class="action-icon-button edit-button" onclick="iniciarEdicao(${index})" title="Edit Item"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button class="action-icon-button delete-button" onclick="removerItem(${index})" title="Remove Item"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3-3V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </td>`;
            });
        }

        window.removerItem = (index) => {
            if (editingIndex === index) finalizarEdicao();
            const removedItem = listaItens[index];
            if (removedItem.type.includes('wire')) listaItens = listaItens.filter(item => item !== removedItem && item.parentWireNumber !== removedItem.wireNumber);
            else listaItens.splice(index, 1);
            exibirMensagem("Item removed.", "success");
            if (editingIndex !== null && editingIndex > index) editingIndex--;
            atualizarInterfaceCompleta();
        };

        function atualizarTotal() {
            totalEstimativa = listaItens.reduce((total, item) => total + (item.subtotal || 0), 0);
            allDomElements.totalEstimativaElement.textContent = formatCurrency(totalEstimativa);
        }
        
        function desenharRede() {
            const canvas = allDomElements.ramalCanvas, ctx = ramalCanvasCtx, canvasWidth = canvas.offsetWidth;
            canvas.width = canvasWidth; canvas.height = 600;
            ctx.clearRect(0, 0, canvasWidth, canvas.height); ctx.save();
            ctx.translate(canvasWidth / 2, canvas.height / 2); ctx.scale(zoomLevel, zoomLevel); ctx.translate(-canvasWidth / 2, -canvas.height / 2);
            
            const paddingX = 60, mainWireY = canvas.height / 2, itemMarkerSize = 8, wireStrokeWidth = 3;
            const mainWireColor = "#000000", labelColor = "#1f2937";
            const wireMap = {};
            
            const mainWire = listaItens.find(item => item.type === 'main-wire');
            if (!mainWire) {
                ctx.restore(); ctx.font = "16px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = "center";
                ctx.fillText("Add a Main Wire to start.", canvasWidth / 2, canvas.height / 2);
                return;
            }

            const mainStartX = paddingX, mainEndX = canvasWidth - paddingX, mainVisualLength = mainEndX - mainStartX;
            const mainPixelPerMeter = mainWire.length > 0 ? mainVisualLength / mainWire.length : 0;
            ctx.beginPath(); ctx.moveTo(mainStartX, mainWireY); ctx.lineTo(mainEndX, mainWireY);
            ctx.strokeStyle = mainWireColor; ctx.lineWidth = wireStrokeWidth; ctx.stroke();
            ctx.font = "14px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = "left";
            ctx.fillText(`Wire ${mainWire.wireNumber} (${mainWire.length}m)`, mainStartX, mainWireY - 15);
            wireMap[mainWire.wireNumber] = { canvasStartX: mainStartX, canvasStartY: mainWireY, pixelPerMeter: mainPixelPerMeter, orientation: 'horizontal' };

            const baseAngleBelow = Math.PI / 6, baseAngleAbove = -Math.PI / 6, angleIncrement = Math.PI / 18;
            let branchesBelowCount = 0, branchesAboveCount = 0;

            listaItens.filter(item => item.type === 'secondary-wire' && item.parentWireNumber === mainWire.wireNumber)
                .sort((a, b) => a.integrationDistance - b.integrationDistance)
                .forEach(secondaryWire => {
                    const attachX = mainStartX + secondaryWire.integrationDistance * mainPixelPerMeter, attachY = mainWireY;
                    const visualDiagonalLength = secondaryWire.length * mainPixelPerMeter * 0.8;
                    let finalAngle = secondaryWire.direction === 'below' ? baseAngleBelow + (branchesBelowCount++ * angleIncrement) : baseAngleAbove - (branchesAboveCount++ * angleIncrement);
                    const deltaX = visualDiagonalLength * Math.cos(finalAngle), deltaY = visualDiagonalLength * Math.sin(finalAngle);
                    const branchEndX = attachX + deltaX, branchEndY = attachY + deltaY;
                    ctx.beginPath(); ctx.moveTo(attachX, attachY); ctx.lineTo(branchEndX, branchEndY); ctx.strokeStyle = mainWireColor; ctx.stroke();
                    ctx.save(); ctx.translate(attachX + (deltaX * 0.15), attachY + (deltaY * 0.15)); ctx.rotate(finalAngle);
                    ctx.font = "12px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = "left";
                    ctx.fillText(`Wire ${secondaryWire.wireNumber} (${secondaryWire.length}m)`, 5, -5); ctx.restore();
                    const secondaryPixelPerMeter = secondaryWire.length > 0 ? visualDiagonalLength / secondaryWire.length : 0;
                    wireMap[secondaryWire.wireNumber] = { canvasStartX: attachX, canvasStartY: attachY, pixelPerMeter: secondaryPixelPerMeter, orientation: 'diagonal', angle: finalAngle };
            });

            let labelPositionToggle = true;
            listaItens.filter(item => item.type === 'component' || item.type === 'connector').sort((a,b) => a.parentWireNumber.localeCompare(b.parentWireNumber) || a.distance - b.distance)
                .forEach(item => {
                    const parentWireEntry = wireMap[item.parentWireNumber];
                    if (!parentWireEntry) return;
                    let itemX, itemY;
                    const itemVisualDist = item.distance * parentWireEntry.pixelPerMeter;
                    if (parentWireEntry.orientation === 'horizontal') { itemX = parentWireEntry.canvasStartX + itemVisualDist; itemY = parentWireEntry.canvasStartY; }
                    else { itemX = parentWireEntry.canvasStartX + (itemVisualDist * Math.cos(parentWireEntry.angle)); itemY = parentWireEntry.canvasStartY + (itemVisualDist * Math.sin(parentWireEntry.angle)); }
                    ctx.save(); ctx.translate(itemX, itemY); ctx.rotate(parentWireEntry.angle || 0);
                    const itemIdentifier = item.type === 'connector' ? 'connector' : item.itemType;
                    switch(itemIdentifier) {
                        case 'connector': ctx.fillStyle = "#ef4444"; ctx.fillRect(-itemMarkerSize/2, -itemMarkerSize/2, itemMarkerSize, itemMarkerSize); break;
                        case 'Grommet': ctx.fillStyle = "#f97316"; ctx.beginPath(); ctx.moveTo(itemMarkerSize, 0); ctx.lineTo(-itemMarkerSize / 2, -itemMarkerSize / 2); ctx.lineTo(-itemMarkerSize / 2, itemMarkerSize / 2); ctx.closePath(); ctx.fill(); break;
                        case 'Tape': ctx.fillStyle = "#1f2937"; ctx.fillRect(-itemMarkerSize, -itemMarkerSize / 2, itemMarkerSize * 2, itemMarkerSize); break;
                        case 'Splice': ctx.fillStyle = "#d1d5db"; ctx.fillRect(-itemMarkerSize / 8, -itemMarkerSize * 1.5, itemMarkerSize / 4, itemMarkerSize * 3); break;
                        default: ctx.fillStyle = "#059669"; ctx.beginPath(); ctx.arc(0, 0, itemMarkerSize / 2, 0, 2 * Math.PI); ctx.fill(); break;
                    }
                    ctx.restore();
                    ctx.font = "10px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = 'center';
                    const labelYOffset = labelPositionToggle ? -12 : 22;
                    ctx.fillText(`${item.quantity}x ${item.model}`, itemX, itemY + labelYOffset);
                    labelPositionToggle = !labelPositionToggle;
            });

            ctx.font = "14px Inter"; ctx.fillStyle = mainWireColor;
            ctx.textAlign = "left"; ctx.fillText("Start", paddingX, mainWireY + 20);
            ctx.textAlign = "right"; ctx.fillText("End", canvasWidth - paddingX, mainWireY + 20);
            ctx.restore();
        }
        function zoomIn() { zoomLevel += zoomStep; desenharRede(); }
        function zoomOut() { if (zoomLevel - zoomStep >= 0.2) { zoomLevel -= zoomStep; desenharRede(); } }
        async function exportToPdf() {
            exibirMensagem("Generating PDF...", "success");
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const margin = 15;
            let yOffset = margin;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const usableWidth = pageWidth - (2 * margin);
            pdf.setFontSize(20); pdf.text("Electrical Network Budget Report", pageWidth / 2, yOffset, { align: 'center' }); yOffset += 12;
            pdf.setFontSize(12);
            pdf.text(`Project: ${allDomElements.projetoInput.value || 'N/A'}`, margin, yOffset);
            pdf.text(`Author: ${allDomElements.autorInput.value || 'N/A'}`, margin, yOffset + 7);
            pdf.text(`Region: ${allDomElements.regiaoSelect.value || 'N/A'}`, margin, yOffset + 14);
            yOffset += 25;
            if (listaItens.length > 0) {
                pdf.setFontSize(16); pdf.text("Material List", margin, yOffset); yOffset += 8;
                const tableCanvas = await html2canvas(document.querySelector(".table-container"), { scale: 2 });
                const tableImgData = tableCanvas.toDataURL('image/png');
                const tableImgHeight = (tableCanvas.height * usableWidth) / tableCanvas.width;
                if (yOffset + tableImgHeight > pdf.internal.pageSize.getHeight() - margin) { pdf.addPage(); yOffset = margin; }
                pdf.addImage(tableImgData, 'PNG', margin, yOffset, usableWidth, tableImgHeight);
                yOffset += tableImgHeight + 10;
            }
            if (yOffset + 20 > pdf.internal.pageSize.getHeight() - margin) { pdf.addPage(); yOffset = margin; }
            pdf.setFontSize(14); pdf.text(`Total Estimated Cost: ${allDomElements.totalEstimativaElement.textContent}`, margin, yOffset); yOffset += 15;
            if (listaItens.find(item => item.type === 'main-wire')) {
                if (yOffset + 80 > pdf.internal.pageSize.getHeight() - margin) { pdf.addPage(); yOffset = margin; }
                pdf.setFontSize(16); pdf.text("Wire View", margin, yOffset); yOffset += 8;
                const canvasImage = allDomElements.ramalCanvas.toDataURL('image/png', 1.0);
                const imgHeightCanvas = (allDomElements.ramalCanvas.height * usableWidth) / allDomElements.ramalCanvas.width;
                pdf.addImage(canvasImage, 'PNG', margin, yOffset, usableWidth, imgHeightCanvas);
            }
            pdf.save(`${(allDomElements.projetoInput.value || 'Report').replace(/ /g, '_')}.pdf`);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            preencherStaticSelects();
            finalizarEdicao();
            allDomElements.mainWire.insulation.addEventListener("change", () => toggleCustomWireFields('main'));
            allDomElements.secondaryWire.insulation.addEventListener("change", () => toggleCustomWireFields('secondary'));
            allDomElements.component.type.addEventListener("change", (e) => preencherComponentModelSelect(e.target.value));
            allDomElements.component.model.addEventListener("change", toggleCustomComponentFields);
            allDomElements.connector.model.addEventListener("change", toggleCustomConnectorFields);
            allDomElements.repeatComponentButton.addEventListener("click", repeatLastComponent);
            allDomElements.repeatConnectorButton.addEventListener("click", repeatLastConnector);
            allDomElements.zoomInButton.addEventListener("click", zoomIn);
            allDomElements.zoomOutButton.addEventListener("click", zoomOut);
            allDomElements.exportPdfButton.addEventListener("click", exportToPdf);
            window.addEventListener('resize', desenharRede);
        });
        
        function toggleCustomWireFields(wireType) {
            const isMain = wireType === 'main';
            const dom = isMain ? allDomElements.mainWire : allDomElements.secondaryWire;
            const show = dom.insulation.value === 'Other';
            dom.customFields.forEach(field => field.classList.toggle('hidden', !show));
            dom.gauge.disabled = show;
            if (show) dom.gauge.value = "";
        }
        function toggleCustomComponentFields() {
             allDomElements.component.customFields.forEach(field => field.classList.toggle('hidden', allDomElements.component.model.value !== 'custom'));
        }
        function toggleCustomConnectorFields() {
             allDomElements.connector.customFields.forEach(field => field.classList.toggle('hidden', allDomElements.connector.model.value !== 'custom'));
        }
        function preencherComponentModelSelect(selectedType) {
            const { component } = allDomElements;
            component.model.innerHTML = '<option value="" disabled selected>Select Model</option>';
            component.model.disabled = true;
            toggleCustomComponentFields();
            const componentType = componentTypesData.find(ct => ct.type === selectedType);
            if (!componentType) return;
            if (componentType.isDirectPrice) {
                component.model.innerHTML = '<option value="N/A" selected>N/A (Direct Price)</option>';
            } else if (componentType.models?.length > 0) {
                componentType.models.forEach(model => component.model.add(new Option(model.model, model.model)));
                component.model.disabled = false;
                component.model.add(new Option("Other / Custom", "custom"));
            }
        }
        function preencherWireSelects() {
            const selects = [allDomElements.secondaryWire.parent, allDomElements.component.wire, allDomElements.connector.wire];
            selects.forEach(s => {
                const currentVal = s.value;
                s.innerHTML = '<option value="" disabled selected>Select Wire</option>';
                const wires = listaItens.filter(item => item.type.includes('wire'));
                if (wires.length === 0) { s.disabled = true; return; };
                s.disabled = false;
                wires.forEach(wire => s.add(new Option(`Wire ${wire.wireNumber}`, wire.wireNumber)));
                if (wires.some(w => w.wireNumber === currentVal)) s.value = currentVal;
            });
        }
    </script>
</body>
</html>