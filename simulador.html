<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wire Budget Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: #f7fafc; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .heading-primary { font-size: 2.25rem; font-weight: 700; color: #1e293b; margin-bottom: 1.5rem; text-align: center; }
        .form-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
        .form-section:first-of-type { border-top: none; margin-top: 0; padding-top: 0; }
        .section-heading { font-size: 1.5rem; font-weight: 600; color: #334155; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 1rem; font-weight: 500; color: #334155; margin-bottom: 0.5rem; }
        .form-input, .form-select { display: block; width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; color: #4b5563; background-color: #fff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvgxmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='none' stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1rem; padding-right: 2.5rem; }
        .action-button { color: white; font-weight: 600; padding: 0.625rem 1.25rem; border-radius: 0.375rem; transition: background-color 0.15s ease-in-out; margin-top: 1rem; border: none; cursor: pointer; }
        .add-button { background-color: #10b981; } .add-button:hover { background-color: #059669; }
        .update-button { background-color: #3b82f6; } .update-button:hover { background-color: #2563eb; }
        .cancel-button { background-color: #6b7280; } .cancel-button:hover { background-color: #4b5563; }
        .table-container { overflow-x: auto; margin-top: 3rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 0.5rem; overflow: hidden; }
        .table-header th { background-color: #f0f4f8; color: #334155; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
        .table-body td { padding: 1rem; color: #4b5563; border-bottom: 1px solid #f2f2f2; }
        .table-body tr:last-child td { border-bottom: none; }
        .table-body tr:hover { background-color: #f7fafc; }
        .action-icon-button { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem; border-radius: 0.375rem; background-color: transparent; border: none; cursor: pointer; transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out; }
        .delete-button { color: #dc2626; } .delete-button:hover { color: #b91c1c; background-color: #fee2e2; }
        .edit-button { color: #2563eb; } .edit-button:hover { color: #1d4ed8; background-color: #dbeafe; }
        .total-section { margin-top: 1.5rem; padding: 1rem; background-color: #eff6ff; border-radius: 0.5rem; border: 1px solid #e0f2fe; display: flex; justify-content: space-between; align-items: center; }
        .total-label { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .total-value { font-size: 1.25rem; color: #15803d; font-weight: 700; }
        .message-container { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; background-color: #f0fdf4; border: 1px solid #d1fae5; color: #065f46; font-weight: 500; text-align: center; }
        .canvas-wrapper { overflow-x: auto; margin-top: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; background-color: #ffffff; }
        #ramal-canvas { display: block; min-width: 100%; height: 600px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-row > .form-group { margin-bottom: 0; }
        .icon-button { background-color: #e5e7eb; color: #4b5563; padding: 0.5rem; border-radius: 9999px; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out; border: none; cursor: pointer; line-height: 0; }
        .icon-button:hover { background-color: #d1d5db; color: #1f2937; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="container">
        <h1 class="heading-primary">Wire Budget Simulator</h1>

        <div class="form-section">
            <h2 class="section-heading">Step 1: Project Information</h2>
            <div class="form-group"><label for="projeto" class="form-label">PROJECT NAME:</label><input type="text" id="projeto" name="projeto" class="form-input" placeholder="Ex: Residential Installation"></div>
            <div class="form-group"><label for="autor" class="form-label">AUTHOR:</label><input type="text" id="autor" name="autor" class="form-input" placeholder="Your Name"></div>
            <div class="form-group"><label for="regiao" class="form-label">REGION:</label><select id="regiao" name="regiao" class="form-select"><option value="" disabled selected>Select Region</option><option value="LAR">LAR</option><option value="EMEA">EMEA</option><option value="NAR">NAR</option><option value="ASIA">ASIA</option></select></div>
        </div>

        <div id="main-wire-form-section" class="form-section item-form-section">
            <h2 class="section-heading">Step 2: MAIN WIRE</h2>
             <div class="form-row"><div class="form-group"><label for="main-wire-length" class="form-label">TOTAL LENGTH (m):</label><input type="number" id="main-wire-length" class="form-input" value="0" min="0"></div><div class="form-group"><label for="main-wire-amount" class="form-label">WIRE AMOUNT:</label><input type="number" id="main-wire-amount" class="form-input" value="1" min="1"></div></div>
             <div class="form-row"><div class="form-group"><label for="main-wire-insulation" class="form-label">INSULATION:</label><select id="main-wire-insulation" class="form-select"></select></div><div class="form-group"><label for="main-wire-gauge" class="form-label">GAUGE (AWG):</label><select id="main-wire-gauge" class="form-select"></select></div></div>
            <div class="form-group custom-main-wire-fields hidden"><label for="custom-main-wire-insulation-name" class="form-label">Custom Insulation Name:</label><input type="text" id="custom-main-wire-insulation-name" class="form-input" placeholder="Ex: XLPE"></div>
            <div class="form-group custom-main-wire-fields hidden"><label for="custom-main-wire-gauge-input" class="form-label">Custom Gauge (AWG):</label><input type="text" id="custom-main-wire-gauge-input" class="form-input" placeholder="Ex: 16.0"></div>
            <div class="form-group custom-main-wire-fields hidden"><label for="custom-main-wire-price-per-meter" class="form-label">Custom Price per Meter ($):</label><input type="number" id="custom-main-wire-price-per-meter" class="form-input" value="0" min="0" step="0.001"></div>
            <div class="form-group"><label for="main-wire-number" class="form-label">WIRE NUMBER:</label><input type="text" id="main-wire-number" class="form-input" placeholder="Ex: W01"></div>
            <div id="main-wire-actions"><button id="adicionar-main-wire" class="action-button add-button">Add Main Wire</button></div>
        </div>

        <div id="branch-wire-form-section" class="form-section item-form-section">
            <h2 class="section-heading">Step 3: BRANCH WIRE</h2>
             <div class="form-row"><div class="form-group"><label for="branch-wire-length" class="form-label">TOTAL LENGTH (m):</label><input type="number" id="branch-wire-length" class="form-input" value="0" min="0"></div><div class="form-group"><label for="branch-wire-amount" class="form-label">WIRE AMOUNT:</label><input type="number" id="branch-wire-amount" class="form-input" value="1" min="1"></div></div>
             <div class="form-row"><div class="form-group"><label for="branch-wire-insulation" class="form-label">INSULATION:</label><select id="branch-wire-insulation" class="form-select"></select></div><div class="form-group"><label for="branch-wire-gauge" class="form-label">GAUGE (AWG):</label><select id="branch-wire-gauge" class="form-select"></select></div></div>
            <div class="form-group custom-branch-wire-fields hidden"><label for="custom-branch-wire-insulation-name" class="form-label">Custom Insulation Name:</label><input type="text" id="custom-branch-wire-insulation-name" class="form-input" placeholder="Ex: TPE"></div>
            <div class="form-group custom-branch-wire-fields hidden"><label for="custom-branch-wire-gauge-input" class="form-label">Custom Gauge (AWG):</label><input type="text" id="custom-branch-wire-gauge-input" class="form-input" placeholder="Ex: 26"></div>
            <div class="form-group custom-branch-wire-fields hidden"><label for="custom-branch-wire-price-per-meter" class="form-label">Custom Price per Meter ($):</label><input type="number" id="custom-branch-wire-price-per-meter" class="form-input" value="0" min="0" step="0.001"></div>
            <div class="form-row"><div class="form-group"><label for="branch-wire-number" class="form-label">WIRE NUMBER:</label><input type="text" id="branch-wire-number" class="form-input" placeholder="Ex: W02"></div><div class="form-group"><label for="branch-wire-integration-wire" class="form-label">CONNECT TO WIRE:</label><select id="branch-wire-integration-wire" class="form-select"></select></div></div>
             <div class="form-group"><label for="branch-wire-integration-distance" class="form-label">INTEGRATION DISTANCE (m on parent wire):</label><input type="number" id="branch-wire-integration-distance" class="form-input" value="0" min="0"></div>
            <div class="form-group"><label class="form-label">Branch Direction:</label><div class="flex items-center space-x-6 py-2"><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" id="direction-below-branch" name="branch-direction-branch" value="below" class="form-radio h-4 w-4 text-blue-600" checked><span>Below Parent</span></label><label class="flex items-center space-x-2 cursor-pointer"><input type="radio" id="direction-above-branch" name="branch-direction-branch" value="above" class="form-radio h-4 w-4 text-blue-600"><span>Above Parent</span></label></div></div>
            <div id="branch-wire-actions"><button id="adicionar-branch-wire" class="action-button add-button">Add Branch Wire</button></div>
        </div>

        <div id="component-form-section" class="form-section item-form-section">
            <h2 class="section-heading">Step 4: COMPONENTS</h2>
             <div class="form-row"><div class="form-group"><label for="component-type" class="form-label">COMPONENT TYPE:</label><select id="component-type" class="form-select"></select></div><div class="form-group"><label for="component-model" class="form-label">MODEL:</label><select id="component-model" class="form-select" disabled></select></div></div>
            <div class="form-group custom-component-fields hidden"><label for="custom-component-name" class="form-label">Custom Name:</label><input type="text" id="custom-component-name" class="form-input" placeholder="Ex: New Component Type"></div>
            <div class="form-group custom-component-fields hidden"><label for="custom-component-price" class="form-label">Custom Unit Price ($):</label><input type="number" id="custom-component-price" class="form-input" value="0" min="0" step="0.01"></div>
            <div class="form-row"><div class="form-group"><label for="component-wire" class="form-label">ATTACH TO WIRE:</label><select id="component-wire" class="form-select"></select></div><div class="form-group"><label for="component-distance" class="form-label">DISTANCE (m on wire):</label><input type="number" id="component-distance" class="form-input" value="0" min="0"></div></div>
             <div class="form-group"><label for="component-quantity" class="form-label">QUANTITY:</label><input type="number" id="component-quantity" class="form-input" value="1" min="1" step="any"></div>
            <div id="component-actions"><button id="adicionar-componente" class="action-button add-button">Add Component</button><button id="repeat-component" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last</button></div>
        </div>

        <div id="connector-form-section" class="form-section item-form-section">
            <h2 class="section-heading">Step 5: CONNECTOR</h2>
             <div class="form-row"><div class="form-group"><label for="connector-model" class="form-label">MODEL:</label><select id="connector-model" class="form-select"></select></div><div class="form-group"><label for="connector-wire" class="form-label">ATTACH TO WIRE:</label><select id="connector-wire" class="form-select"></select></div></div>
            <div class="form-group custom-connector-fields hidden"><label for="custom-connector-name" class="form-label">Custom Name:</label><input type="text" id="custom-connector-name" class="form-input" placeholder="Ex: Ultra Connector"></div>
            <div class="form-group custom-connector-fields hidden"><label for="custom-connector-price" class="form-label">Custom Unit Price ($):</label><input type="number" id="custom-connector-price" class="form-input" value="0" min="0" step="0.01"></div>
            <div class="form-row"><div class="form-group"><label for="connector-distance" class="form-label">DISTANCE (m on wire):</label><input type="number" id="connector-distance" class="form-input" value="0" min="0"></div><div class="form-group"><label for="connector-quantity" class="form-label">QUANTITY:</label><input type="number" id="connector-quantity" class="form-input" value="1" min="1"></div></div>
            <div id="connector-actions"><button id="adicionar-conector" class="action-button add-button">Add Connector</button><button id="repeat-connector" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last</button></div>
        </div>

        <div class="table-container">
             <table class="table">
                 <thead class="table-header"><tr><th>#</th><th>Type</th><th>Source Wire</th><th>Item / Model / Gauge</th><th>Qty. / Length</th><th>Distance</th><th>Unit Price ($)</th><th>Subtotal ($)</th><th>Actions</th></tr></thead>
                 <tbody id="lista-itens" class="table-body"><tr><td colspan="9" class="text-center text-gray-500">No items added.</td></tr></tbody>
             </table>
        </div>

        <div class="total-section"><span class="total-label">Total Estimate:</span><span id="total-estimativa" class="total-value">$ 0.000</span></div>
        <div class="form-section">
            <div class="flex justify-between items-center">
                <h2 class="section-heading" style="margin-bottom: 0;">Wire View</h2>
                <div class="flex items-center space-x-2">
                    <button id="zoom-out-button" class="icon-button" title="Zoom Out"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button>
                    <button id="zoom-in-button" class="icon-button" title="Zoom In"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button>
                </div>
            </div>
            <div class="canvas-wrapper"><canvas id="ramal-canvas"></canvas></div>
        </div>
        <div class="flex justify-center mt-6"><button id="export-pdf-button" class="action-button bg-purple-600 hover:bg-purple-700">Export to PDF</button></div>
        <div id="mensagem-container" class="message-container" style="display: none;"></div>
    </div>

    <script>
        // --- DATA ---
        const insulationOptions = ["PVC"]; // Alterado
        const gaugeOptions = ["24", "22", "20", "18", "17", "16"];
        
        const componentTypesData = [
            { type: "Bimetal", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.800 },
            { type: "Ferrite", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.800 },
            { type: "Splice", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.060 },
            { type: "POLYAMIDE GLUE", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.154 },
            { type: "HEAT SHRINK TUBE", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.240 },
            { type: "Hot Melt", isDirectPrice: true, unit: "Unit", pricePerUnit: 0.010 },
            {
                type: "Terminal", isDirectPrice: false, models: [
                    { "model": "6-917660", "unit": "Unit", "pricePerUnit": 0.00880 },
                    { "model": "TBD", "unit": "Unit", "pricePerUnit": 0.01264 },
                    { "model": "W10224274", "unit": "Unit", "pricePerUnit": 0.01540 },
                    { "model": "W10224275", "unit": "Unit", "pricePerUnit": 0.2100 },
                    { "model": "W10241280", "unit": "Unit", "pricePerUnit": 0.0410 },
                    { "model": "W10241606", "unit": "Unit", "pricePerUnit": 0.00380 },
                    { "model": "W10241607", "unit": "Unit", "pricePerUnit": 0.01050 },
                    { "model": "W10241608", "unit": "Unit", "pricePerUnit": 0.01030 },
                    { "model": "W10361444", "unit": "Unit", "pricePerUnit": 0.0470 },
                    { "model": "10431333", "unit": "Unit", "pricePerUnit": 0.00528 },
                    { "model": "W10582562", "unit": "Unit", "pricePerUnit": 0.00873 },
                    { "model": "W10704522", "unit": "Unit", "pricePerUnit": 0.01002 },
                    { "model": "W10704522", "unit": "Unit", "pricePerUnit": 0.0570 },
                    { "model": "10863776", "unit": "Unit", "pricePerUnit": 0.00839 },
                    { "model": "W11224007", "unit": "Unit", "pricePerUnit": 0.2160 },
                    { "model": "W11402255", "unit": "Unit", "pricePerUnit": 0.00528 },
                    { "model": "W11561408", "unit": "Unit", "pricePerUnit": 0.033 },
                    { "model": "W11600246", "unit": "Unit", "pricePerUnit": 0.0820 },
                    { "model": "W11620170", "unit": "Unit", "pricePerUnit": 0.0410 },
                    { "model": "W11650942", "unit": "Unit", "pricePerUnit": 0.012 }
                ]
            },
            {
                type: "Tape", isDirectPrice: false, models: [
                    { model: "Masking Tape", unit: "Meter", pricePerUnit: 0.10 },
                    { model: "Electrical Tape", unit: "Roll", pricePerUnit: 2.50 },
                    { model: "GLASS TAPE", unit: "Meter", "pricePerUnit": 0.30 },
                    { model: "PVC", unit: "Meter", "pricePerUnit": 0.0333 } // Adicionado
                ]
            },
            {
                type: "Ground Ring", isDirectPrice: false, models: [
                    { model: "61795-3", unit: "Unit", pricePerUnit: 0.12345 }
                ]
            },
            {
                type: "Retainer", isDirectPrice: false, models: [
                    { "model": "177918-1", "unit": "Unit", "pricePerUnit": 0.011 },
                    { "model": "1-1969443-0", "unit": "Unit", "pricePerUnit": 0.02055 },
                    { "model": "1744544-9", "unit": "Unit", "pricePerUnit": 0.05553 },
                    { "model": "1969443-4", "unit": "Unit", "pricePerUnit": 0.01000 },
                    { "model": "1969443-5", "unit": "Unit", "pricePerUnit": 0.01000 },
                    { "model": "1969443-7", "unit": "Unit", "pricePerUnit": 0.02000 },
                    { "model": "1971778-3", "unit": "Unit", "pricePerUnit": 0.04970 },
                    { "model": "917700-1", "unit": "Unit", "pricePerUnit": 0.01000 },
                    { "model": "PMS-04V-S", "unit": "Unit", "pricePerUnit": 0.01000 },
                    { "model": "VLS-02V", "unit": "Unit", "pricePerUnit": 0.01510 },
                    { "model": "VLS-03V", "unit": "Unit", "pricePerUnit": 0.02510 },
                    { "model": "XMS-04V", "unit": "Unit", "pricePerUnit": 0.01330 },
                    { "model": "YLS-02V", "unit": "Unit", "pricePerUnit": 0.01000 },
                    { "model": "YLS-03V", "unit": "Unit", "pricePerUnit": 0.01640 }
                ]
            },
            {
                type: "Grommet", isDirectPrice: false, models: [
                    { model: "12.5mm", unit: "Unit", pricePerUnit: 0.05 },
                    { model: "19mm", unit: "Unit", pricePerUnit: 0.06 },
                    { model: "30mm", unit: "Unit", pricePerUnit: 0.08 }
                ]
            }
        ];

        const connectorModelsData = [
            { "model": "W10201940", "unit": "Unit", "pricePerUnit": 0.02010 },
            { "model": "W10208161", "unit": "Unit", "pricePerUnit": 0.01570 },
            { "model": "W10208162", "unit": "Unit", "pricePerUnit": 0.01690 },
            { "model": "W10210598", "unit": "Unit", "pricePerUnit": 0.05191 },
            { "model": "W10241087", "unit": "Unit", "pricePerUnit": 0.02563 },
            { "model": "W10439936", "unit": "Unit", "pricePerUnit": 0.06310 },
            { "model": "W10460700", "unit": "Unit", "pricePerUnit": 0.03920 },
            { "model": "W10519359", "unit": "Unit", "pricePerUnit": 0.02000 },
            { "model": "W10709241", "unit": "Unit", "pricePerUnit": 0.02676 },
            { "model": "W10791640", "unit": "Unit", "pricePerUnit": 0.03281 },
            { "model": "W10850299", "unit": "Unit", "pricePerUnit": 0.02113 },
            { "model": "W10863576", "unit": "Unit", "pricePerUnit": 0.03275 },
            { "model": "W10867932", "unit": "Unit", "pricePerUnit": 0.03680 },
            { "model": "W10871531", "unit": "Unit", "pricePerUnit": 0.03040 },
            { "model": "W11295937", "unit": "Unit", "pricePerUnit": 0.04570 },
            { "model": "W11372511", "unit": "Unit", "pricePerUnit": 0.02372 },
            { "model": "W11404384", "unit": "Unit", "pricePerUnit": 0.06310 },
            { "model": "W11461251", "unit": "Unit", "pricePerUnit": 0.08580 },
            { "model": "W11568062", "unit": "Unit", "pricePerUnit": 0.05369 },
            { "model": "W11569744", "unit": "Unit", "pricePerUnit": 0.04863 },
            { "model": "W11635490", "unit": "Unit", "pricePerUnit": 0.05181 },
            { "model": "W11659551", "unit": "Unit", "pricePerUnit": 0.02805 },
            { "model": "W11659561", "unit": "Unit", "pricePerUnit": 0.00894 },
            { "model": "W11675256", "unit": "Unit", "pricePerUnit": 0.02497 },
            { "model": "W11681314", "unit": "Unit", "pricePerUnit": 0.07432 },
            { "model": "W11681334", "unit": "Unit", "pricePerUnit": 0.06770 },
            { "model": "W11686060", "unit": "Unit", "pricePerUnit": 0.10765 }
        ];

        const wirePriceData = [ { gauge: "24", pricePerMeterSingle: 0.05 },{ gauge: "22", pricePerMeterSingle: 0.06 },{ gauge: "20", pricePerMeterSingle: 0.07 },{ gauge: "18", pricePerMeterSingle: 0.08 },{ gauge: "17", pricePerMeterSingle: 0.09 },{ gauge: "16", pricePerMeterSingle: 0.10 } ];

        // --- DOM Elements ---
        const allDomElements = {
            projetoInput: document.getElementById("projeto"), autorInput: document.getElementById("autor"), regiaoSelect: document.getElementById("regiao"),
            mainWire: { length: document.getElementById("main-wire-length"), amount: document.getElementById("main-wire-amount"), insulation: document.getElementById("main-wire-insulation"), gauge: document.getElementById("main-wire-gauge"), customInsulation: document.getElementById("custom-main-wire-insulation-name"), customGauge: document.getElementById("custom-main-wire-gauge-input"), customPrice: document.getElementById("custom-main-wire-price-per-meter"), customFields: document.querySelectorAll(".custom-main-wire-fields"), number: document.getElementById("main-wire-number"), actions: document.getElementById("main-wire-actions"), formSection: document.getElementById("main-wire-form-section") },
            branchWire: { length: document.getElementById("branch-wire-length"), amount: document.getElementById("branch-wire-amount"), insulation: document.getElementById("branch-wire-insulation"), gauge: document.getElementById("branch-wire-gauge"), customInsulation: document.getElementById("custom-branch-wire-insulation-name"), customGauge: document.getElementById("custom-branch-wire-gauge-input"), customPrice: document.getElementById("custom-branch-wire-price-per-meter"), customFields: document.querySelectorAll(".custom-branch-wire-fields"), number: document.getElementById("branch-wire-number"), parent: document.getElementById("branch-wire-integration-wire"), distance: document.getElementById("branch-wire-integration-distance"), actions: document.getElementById("branch-wire-actions"), formSection: document.getElementById("branch-wire-form-section") },
            component: { type: document.getElementById("component-type"), model: document.getElementById("component-model"), customName: document.getElementById("custom-component-name"), customPrice: document.getElementById("custom-component-price"), customFields: document.querySelectorAll(".custom-component-fields"), wire: document.getElementById("component-wire"), distance: document.getElementById("component-distance"), quantity: document.getElementById("component-quantity"), quantityLabel: document.querySelector('label[for="component-quantity"]'), actions: document.getElementById("component-actions"), formSection: document.getElementById("component-form-section") },
            connector: { model: document.getElementById("connector-model"), customName: document.getElementById("custom-connector-name"), customPrice: document.getElementById("custom-connector-price"), customFields: document.querySelectorAll(".custom-connector-fields"), wire: document.getElementById("connector-wire"), distance: document.getElementById("connector-distance"), quantity: document.getElementById("connector-quantity"), actions: document.getElementById("connector-actions"), formSection: document.getElementById("connector-form-section") },
            listaItensBody: document.getElementById("lista-itens"), totalEstimativaElement: document.getElementById("total-estimativa"), mensagemContainer: document.getElementById("mensagem-container"), ramalCanvas: document.getElementById("ramal-canvas"), exportPdfButton: document.getElementById("export-pdf-button"), zoomInButton: document.getElementById("zoom-in-button"), zoomOutButton: document.getElementById("zoom-out-button"), repeatComponentButton: document.getElementById("repeat-component"), repeatConnectorButton: document.getElementById("repeat-connector")
        };
        const ramalCanvasCtx = allDomElements.ramalCanvas.getContext("2d");

        // --- Application State ---
        let listaItens = [], totalEstimativa = 0, lastAddedComponent = null, lastAddedConnector = null, zoomLevel = 1.0, zoomStep = 0.1, editingIndex = null;
        
        // --- UI & Helper Functions ---
        const formatCurrency = (value) => `$${(value || 0).toFixed(3)}`;
        
        function exibirMensagem(message, type = "success") {
            const container = allDomElements.mensagemContainer;
            container.textContent = message;
            container.style.display = "block";
            container.className = `message-container ${type === "success" ? 'bg-green-100 border-green-400 text-green-800' : 'bg-red-100 border-red-400 text-red-800'}`;
            setTimeout(() => { container.style.display = "none"; }, 3000);
        }

        function clearAllForms() {
            document.querySelectorAll('.item-form-section input[type="text"], .item-form-section input[type="number"]').forEach(input => {
                if (input.name.includes('quantity') || input.name.includes('amount')) input.value = "1";
                else if (input.type === 'number') input.value = "0";
                else input.value = "";
            });
            document.querySelectorAll('.item-form-section select').forEach(select => {
                select.selectedIndex = 0;
                select.dispatchEvent(new Event('change'));
            });
        }

        function preencherStaticSelects() {
            const { mainWire, branchWire, component, connector } = allDomElements;
            [mainWire.insulation, branchWire.insulation].forEach(select => {
                select.innerHTML = '<option value="" disabled selected>Select Insulation</option>';
                insulationOptions.forEach(item => select.add(new Option(item, item)));
                select.add(new Option("Other / Custom", "Other")); // Alterado
            });
            [mainWire.gauge, branchWire.gauge].forEach(select => {
                select.innerHTML = '<option value="" disabled selected>Select Gauge</option>';
                gaugeOptions.forEach(item => select.add(new Option(item, item)));
            });
            component.type.innerHTML = '<option value="" disabled selected>Select Type</option>';
            componentTypesData.forEach(compType => component.type.add(new Option(compType.isDirectPrice ? compType.type.toUpperCase() : compType.type, compType.type)));
            component.type.add(new Option("Other / Custom Type", "custom-type")); // Adicionado
            
            connector.model.innerHTML = '<option value="" disabled selected>Select Model</option>';
            connectorModelsData.forEach(conn => connector.model.add(new Option(conn.model, conn.model)));
            connector.model.add(new Option("Other / Custom", "custom"));
        }

        function atualizarInterfaceCompleta() {
            preencherWireSelects();
            atualizarLista();
            atualizarTotal();
            desenharRede();
        }

        // --- ADD / EDIT / UPDATE ---

        function handleAddItem(type, itemData) {
            listaItens.push(itemData);
            exibirMensagem(`${type} added successfully.`, "success");
            clearAllForms();
            atualizarInterfaceCompleta();
        }

        function handleUpdateItem(type, itemData) {
            listaItens[editingIndex] = itemData;
            exibirMensagem(`${type} updated successfully.`, "success");
            finalizarEdicao();
        }

        function collectAndValidateWireData(wireType) {
            const domSets = { main: allDomElements.mainWire, branch: allDomElements.branchWire };
            const dom = domSets[wireType];
            const length = parseFloat(dom.length.value), amount = parseInt(dom.amount.value), wireNumber = dom.number.value.trim();
            let insulation = dom.insulation.value, gauge = dom.gauge.value, finalInsulationName, finalGauge, finalPricePerMeterSingleWire;

            if (insulation === 'Other') {
                finalInsulationName = dom.customInsulation.value.trim();
                finalGauge = dom.customGauge.value.trim();
                finalPricePerMeterSingleWire = parseFloat(dom.customPrice.value);
                if (!finalInsulationName || !finalGauge || isNaN(finalPricePerMeterSingleWire) || finalPricePerMeterSingleWire <= 0) {
                    exibirMensagem("Please fill all custom Wire fields (Name, Gauge, Price > 0).", "erro"); return null;
                }
            } else {
                finalInsulationName = insulation; finalGauge = gauge;
                if (!finalInsulationName || !finalGauge) { exibirMensagem("Please select Insulation and Gauge.", "erro"); return null; }
                finalPricePerMeterSingleWire = wirePriceData.find(item => item.gauge === finalGauge)?.pricePerMeterSingle || 0;
            }

            if (isNaN(length) || isNaN(amount) || length <= 0 || amount <= 0 || !wireNumber) { exibirMensagem("Please fill Length, Amount, and Wire Number.", "erro"); return null; }
            if (listaItens.some((item, index) => item.wireNumber === wireNumber && index !== editingIndex)) { exibirMensagem(`Wire Number "${wireNumber}" is already in use.`, "erro"); return null; }

            const baseData = { wireNumber, length, amount, insulation: finalInsulationName, gauge: finalGauge, pricePerUnit: finalPricePerMeterSingleWire };
            
            if (wireType === 'main') {
                if (listaItens.some(item => item.type === 'main-wire' && (editingIndex === null || listaItens[editingIndex].wireNumber !== item.wireNumber))) {
                    exibirMensagem("A Main Wire already exists.", "erro"); return null;
                }
                return { ...baseData, type: 'main-wire', subtotal: length * finalPricePerMeterSingleWire * amount };
            } else { // 'branch'
                const parentWireNumber = dom.parent.value;
                const integrationDistance = parseFloat(dom.distance.value);
                const direction = document.querySelector(`input[name="branch-direction-branch"]:checked`).value;
                if (!parentWireNumber || isNaN(integrationDistance) || integrationDistance < 0) { exibirMensagem("Please select a parent wire and set a valid integration distance.", "erro"); return null; }
                const parentWire = listaItens.find(item => item.wireNumber === parentWireNumber);
                if (!parentWire) { exibirMensagem(`Parent wire "${parentWireNumber}" not found.`, "erro"); return null; }
                if (integrationDistance > parentWire.length) { exibirMensagem(`Integration distance exceeds the length of parent wire.`, "erro"); return null; }
                
                return { ...baseData, type: 'branch-wire', parentWireNumber, integrationDistance, direction, subtotal: length * finalPricePerMeterSingleWire * amount };
            }
        }
        
        function adicionarFioPrincipal() { const itemData = collectAndValidateWireData('main'); if (itemData) handleAddItem("Main Wire", itemData); }
        function adicionarBranchWire() { const itemData = collectAndValidateWireData('branch'); if (itemData) handleAddItem("Branch Wire", itemData); }
        
        window.iniciarEdicao = (index) => {
            if (editingIndex !== null) { exibirMensagem("Please finish the current edit first.", "erro"); return; }
            editingIndex = index;
            const item = listaItens[index];
            let formType, dom;

            switch(item.type) {
                case 'main-wire': formType = 'main'; dom = allDomElements.mainWire; break;
                case 'branch-wire': formType = 'branch'; dom = allDomElements.branchWire; break;
                case 'component': popularFormularioComponente(item); configurarBotoesParaEdicao('component'); allDomElements.component.formSection.scrollIntoView({ behavior: 'smooth' }); return;
                case 'connector': popularFormularioConector(item); configurarBotoesParaEdicao('connector'); allDomElements.connector.formSection.scrollIntoView({ behavior: 'smooth' }); return;
            }
            popularFormularioFio(formType, item);
            configurarBotoesParaEdicao(item.type);
            dom.formSection.scrollIntoView({ behavior: 'smooth' });
            exibirMensagem(`Editing Item #${index + 1}.`, "success");
        };

        function popularFormularioFio(wireType, item) {
            const domSets = { main: allDomElements.mainWire, branch: allDomElements.branchWire };
            const dom = domSets[wireType];
            dom.length.value = item.length; dom.amount.value = item.amount; dom.number.value = item.wireNumber;
            const isStandardInsulation = insulationOptions.includes(item.insulation);
            dom.insulation.value = isStandardInsulation ? item.insulation : "Other";
            dom.insulation.dispatchEvent(new Event('change'));
            if (!isStandardInsulation) {
                dom.customInsulation.value = item.insulation; dom.customGauge.value = item.gauge; dom.customPrice.value = item.pricePerUnit;
            } else { dom.gauge.value = item.gauge; }
            if (wireType === 'branch') {
                dom.parent.value = item.parentWireNumber; dom.distance.value = item.integrationDistance;
                document.querySelector(`input[name="branch-direction-branch"][value="${item.direction || 'below'}"]`).checked = true;
            }
        }
        
        function configurarBotoesParaEdicao(type) {
            const sections = { 'main-wire': allDomElements.mainWire.actions, 'branch-wire': allDomElements.branchWire.actions, 'component': allDomElements.component.actions, 'connector': allDomElements.connector.actions };
            document.querySelectorAll('.action-button.add-button, .action-button.bg-gray-500').forEach(btn => btn.disabled = true);

            for (const key in sections) {
                const btnContainer = sections[key];
                if (type === key) {
                    btnContainer.innerHTML = `<button class="action-button update-button">Update</button><button class="action-button cancel-button ml-2">Cancel</button>`;
                    btnContainer.querySelector('.update-button').addEventListener('click', () => atualizarItem(key));
                    btnContainer.querySelector('.cancel-button').addEventListener('click', finalizarEdicao);
                     btnContainer.querySelector('.update-button').disabled = false;
                } else { 
                    Array.from(btnContainer.children).forEach(btn => btn.disabled = true); 
                }
            }
        }

        function atualizarItem(type) {
            let itemData;
            switch(type) {
                case 'main-wire': itemData = collectAndValidateWireData('main'); if (itemData) handleUpdateItem("Main Wire", itemData); break;
                case 'branch-wire': itemData = collectAndValidateWireData('branch'); if (itemData) handleUpdateItem("Branch Wire", itemData); break;
                case 'component': adicionarComponenteItem(true); break;
                case 'connector': adicionarConector(true); break;
            }
        }
        
        function finalizarEdicao() {
            editingIndex = null;
            clearAllForms();
            const sections = { mainWire: allDomElements.mainWire, branchWire: allDomElements.branchWire, component: allDomElements.component, connector: allDomElements.connector };
            sections.mainWire.actions.innerHTML = '<button id="adicionar-main-wire" class="action-button add-button">Add Main Wire</button>';
            sections.mainWire.actions.firstChild.addEventListener('click', adicionarFioPrincipal);
            sections.branchWire.actions.innerHTML = '<button id="adicionar-branch-wire" class="action-button add-button">Add Branch Wire</button>';
            sections.branchWire.actions.firstChild.addEventListener('click', adicionarBranchWire);
            sections.component.actions.innerHTML = '<button id="adicionar-componente" class="action-button add-button">Add Component</button><button id="repeat-component" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last</button>';
            sections.component.actions.children[0].addEventListener('click', () => adicionarComponenteItem(false));
            sections.component.actions.children[1].addEventListener('click', repeatLastComponent);
            sections.connector.actions.innerHTML = '<button id="adicionar-conector" class="action-button add-button">Add Connector</button><button id="repeat-connector" class="action-button bg-gray-500 hover:bg-gray-700 ml-2">Repeat Last</button>';
            sections.connector.actions.children[0].addEventListener('click', () => adicionarConector(false));
            sections.connector.actions.children[1].addEventListener('click', repeatLastConnector);
            
            document.querySelectorAll('.action-button').forEach(btn => btn.disabled = false);
            atualizarInterfaceCompleta();
        }
        
        function atualizarLista(){
            const body = allDomElements.listaItensBody;
            if (listaItens.length === 0) { body.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">No items added.</td></tr>'; return; }
            body.innerHTML = "";
            listaItens.sort((a,b) => (a.type === 'main-wire') ? -1 : (b.type === 'main-wire') ? 1 : 0);
            listaItens.forEach((item, index) => {
                const row = body.insertRow();
                let typeName, desc, qty, wire, dist, price;
                switch (item.type) {
                    case 'main-wire': typeName = "Main Wire"; desc = `Main (${item.insulation}, ${item.gauge} AWG) - ${item.wireNumber}`; qty = `${item.length}m (${item.amount} vias)`; wire = '-'; dist = '-'; price = `${formatCurrency(item.pricePerUnit)}/m`; break;
                    case 'branch-wire': typeName = "Branch Wire"; desc = `Branch (${item.insulation}, ${item.gauge} AWG) - ${item.wireNumber}`; qty = `${item.length}m (${item.amount} vias)`; wire = item.parentWireNumber; dist = `${item.integrationDistance}m`; price = `${formatCurrency(item.pricePerUnit)}/m`; break;
                    case 'component': typeName = "Component"; desc = `${item.itemType} - ${item.model}`; qty = `${item.quantity} ${item.unit}`; wire = item.parentWireNumber; dist = `${item.distance}m`; price = `${formatCurrency(item.pricePerUnit)}/${item.unit}`; break;
                    case 'connector': typeName = "Connector"; desc = `Connector - ${item.model}`; qty = `${item.quantity} ${item.unit}`; wire = item.parentWireNumber; dist = `${item.distance}m`; price = `${formatCurrency(item.pricePerUnit)}/${item.unit}`; break;
                }
                row.innerHTML = `<td>${index + 1}</td><td>${typeName}</td><td>${wire}</td><td>${desc}</td><td>${qty}</td><td>${dist}</td><td>${price}</td><td>${formatCurrency(item.subtotal)}</td><td class="flex items-center"><button class="action-icon-button edit-button" onclick="iniciarEdicao(${index})" title="Edit Item"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="action-icon-button delete-button" onclick="removerItem(${index})" title="Remove Item"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3-3V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></td>`;
            });
        }
        
        window.removerItem = (index) => {
            if (editingIndex === index) { finalizarEdicao(); }
            const removedItem = listaItens[index];
            if (removedItem.type.includes('wire')) {
                let itemsToRemove = [removedItem];
                let queue = [removedItem.wireNumber];
                while(queue.length > 0) {
                    let parentNum = queue.shift();
                    let children = listaItens.filter(i => i.parentWireNumber === parentNum);
                    itemsToRemove.push(...children);
                    children.forEach(c => { if (c.type.includes('wire')) queue.push(c.wireNumber); });
                }
                if (itemsToRemove.length > 1 && !confirm(`Removing wire ${removedItem.wireNumber} will also remove ${itemsToRemove.length - 1} child item(s). Are you sure?`)) { return; }
                listaItens = listaItens.filter(item => !itemsToRemove.includes(item));
            } else {
                listaItens.splice(index, 1);
            }
            exibirMensagem("Item(s) removed.", "success");
            if (editingIndex !== null && editingIndex >= index) { editingIndex = null; finalizarEdicao(); }
            atualizarInterfaceCompleta();
        };

        function atualizarTotal() { totalEstimativa = listaItens.reduce((total, item) => total + (item.subtotal || 0), 0); allDomElements.totalEstimativaElement.textContent = formatCurrency(totalEstimativa); }
        
        function desenharRede() {
            const canvas = allDomElements.ramalCanvas, ctx = ramalCanvasCtx, canvasWidth = canvas.offsetWidth;
            canvas.width = canvasWidth; canvas.height = 600;
            ctx.clearRect(0, 0, canvasWidth, canvas.height); ctx.save();
            ctx.translate(canvasWidth / 2, canvas.height / 2); ctx.scale(zoomLevel, zoomLevel); ctx.translate(-canvasWidth / 2, -canvas.height / 2);
            
            const paddingX = 60, mainWireY = canvas.height / 2, wireStrokeWidth = 3, itemMarkerSize = 8;
            const mainWireColor = "#000000", labelColor = "#1f2937";
            const wireMap = {};
            const mainWire = listaItens.find(item => item.type === 'main-wire');
            
            if (!mainWire) {
                ctx.restore(); ctx.font = "16px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = "center";
                ctx.fillText("Add a Main Wire to start.", canvasWidth / 2, canvas.height / 2); return;
            }

            const mainStartX = paddingX, mainEndX = canvasWidth - paddingX;
            const mainPixelPerMeter = mainWire.length > 0 ? (mainEndX - mainStartX) / mainWire.length : 0;
            ctx.beginPath(); ctx.moveTo(mainStartX, mainWireY); ctx.lineTo(mainEndX, mainWireY); ctx.strokeStyle = mainWireColor; ctx.lineWidth = wireStrokeWidth; ctx.stroke();
            ctx.font = "14px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = "left";
            ctx.fillText(`Wire ${mainWire.wireNumber} (${mainWire.length}m)`, mainStartX, mainWireY - 15);
            
            wireMap[mainWire.wireNumber] = { item: mainWire, canvasStartX: mainStartX, canvasStartY: mainWireY, canvasEndX: mainEndX, canvasEndY: mainWireY, angle: 0 };
            
            const wiresToDrawQueue = [mainWire.wireNumber], drawnWires = new Set(wiresToDrawQueue);
            while(wiresToDrawQueue.length > 0) {
                const parentWireNumber = wiresToDrawQueue.shift(), parentInfo = wireMap[parentWireNumber];
                
                const children = listaItens.filter(item => item.type === 'branch-wire' && item.parentWireNumber === parentWireNumber);
                
                let branchesBelowCount = 0, branchesAboveCount = 0;
                children.sort((a,b) => a.integrationDistance - b.integrationDistance).forEach(childWire => {
                    if (!parentInfo.item.length) return;
                    const attachRatio = childWire.integrationDistance / parentInfo.item.length;
                    const attachX = parentInfo.canvasStartX + (parentInfo.canvasEndX - parentInfo.canvasStartX) * attachRatio;
                    const attachY = parentInfo.canvasStartY + (parentInfo.canvasEndY - parentInfo.canvasStartY) * attachRatio;
                    const visualDiagonalLength = childWire.length * mainPixelPerMeter * 0.8;
                    const angleIncrement = Math.PI / 18, baseAngle = Math.PI / 6;
                    let relativeAngle = childWire.direction === 'below' ? baseAngle + (branchesBelowCount++ * angleIncrement) : -baseAngle - (branchesAboveCount++ * angleIncrement);
                    const finalAngle = parentInfo.angle + relativeAngle;
                    const deltaX = visualDiagonalLength * Math.cos(finalAngle), deltaY = visualDiagonalLength * Math.sin(finalAngle);
                    const branchEndX = attachX + deltaX, branchEndY = attachY + deltaY;
                    
                    ctx.beginPath(); ctx.moveTo(attachX, attachY); ctx.lineTo(branchEndX, branchEndY); ctx.strokeStyle = mainWireColor; ctx.stroke();
                    ctx.save();
                    ctx.translate(attachX + (deltaX * 0.15), attachY + (deltaY * 0.15));
                    ctx.rotate(finalAngle);
                    ctx.font = "12px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = "left";
                    ctx.fillText(`${childWire.wireNumber} (${childWire.length}m)`, 5, -5);
                    ctx.restore();

                    wireMap[childWire.wireNumber] = { item: childWire, canvasStartX: attachX, canvasStartY: attachY, canvasEndX: branchEndX, canvasEndY: branchEndY, angle: finalAngle };
                    if (!drawnWires.has(childWire.wireNumber)) { wiresToDrawQueue.push(childWire.wireNumber); drawnWires.add(childWire.wireNumber); }
                });
            }

            let labelPositionToggle = true;
            listaItens.filter(item => item.type === 'component' || item.type === 'connector').forEach(item => {
                const parentInfo = wireMap[item.parentWireNumber];
                if (!parentInfo || !parentInfo.item.length) return;
                const attachRatio = item.distance / parentInfo.item.length;
                const itemX = parentInfo.canvasStartX + (parentInfo.canvasEndX - parentInfo.canvasStartX) * attachRatio;
                const itemY = parentInfo.canvasStartY + (parentInfo.canvasEndY - parentInfo.canvasStartY) * attachRatio;
                ctx.save(); ctx.translate(itemX, itemY); ctx.rotate(parentInfo.angle || 0);
                const itemIdentifier = item.type === 'connector' ? 'connector' : item.itemType;
                switch(itemIdentifier) {
                    case 'connector': ctx.fillStyle = "#ef4444"; ctx.fillRect(-itemMarkerSize/2, -itemMarkerSize/2, itemMarkerSize, itemMarkerSize); break;
                    case 'Grommet': ctx.fillStyle = "#f97316"; ctx.beginPath(); ctx.moveTo(itemMarkerSize, 0); ctx.lineTo(-itemMarkerSize / 2, -itemMarkerSize / 2); ctx.lineTo(-itemMarkerSize / 2, itemMarkerSize / 2); ctx.closePath(); ctx.fill(); break;
                    case 'Tape': ctx.fillStyle = "#1f2937"; ctx.fillRect(-itemMarkerSize, -itemMarkerSize / 2, itemMarkerSize * 2, itemMarkerSize); break;
                    case 'Splice': ctx.fillStyle = "#d1d5db"; ctx.fillRect(-itemMarkerSize / 8, -itemMarkerSize * 1.5, itemMarkerSize / 4, itemMarkerSize * 3); break;
                    default: ctx.fillStyle = "#059669"; ctx.beginPath(); ctx.arc(0, 0, itemMarkerSize / 2, 0, 2 * Math.PI); ctx.fill(); break;
                }
                ctx.restore();
                ctx.font = "10px Inter"; ctx.fillStyle = labelColor; ctx.textAlign = 'center';
                const labelYOffset = labelPositionToggle ? -12 : 22;
                ctx.fillText(`${item.quantity}x ${item.model}`, itemX, itemY + labelYOffset);
                labelPositionToggle = !labelPositionToggle;
            });

            ctx.font = "14px Inter"; ctx.fillStyle = mainWireColor;
            ctx.textAlign = "left"; ctx.fillText("Start", paddingX, mainWireY + 35);
            ctx.textAlign = "right"; ctx.fillText("End", canvasWidth - paddingX, mainWireY + 35);
            ctx.restore();
        }
        
        async function logCustomItemToServer(itemData) {
            const logApiUrl = '/api/log-item';
            try {
                await fetch(logApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
            } catch (error) {
                console.error('Erro de rede ao tentar enviar log:', error);
            }
        }

        function popularFormularioComponente(item) {
            const dom = allDomElements.component; 
            
            // Lógica para lidar com tipo customizado ou não
            const isKnownType = componentTypesData.some(t => t.type === item.itemType);
            if (!isKnownType || item.isCustomType) {
                 dom.type.value = "custom-type";
            } else {
                 dom.type.value = item.itemType;
            }
            dom.type.dispatchEvent(new Event('change'));

            setTimeout(() => { 
                if (dom.type.value === 'custom-type') {
                    dom.customName.value = item.itemType; // Se for custom, o nome vai para o campo custom
                    dom.customPrice.value = item.pricePerUnit;
                } else if (item.isCustom) {
                    dom.model.value = "custom";
                    dom.model.dispatchEvent(new Event('change'));
                    dom.customName.value = item.model; 
                    dom.customPrice.value = item.pricePerUnit;
                } else { 
                    const typeData = componentTypesData.find(t => t.type === item.itemType); 
                    if (typeData && !typeData.isDirectPrice) dom.model.value = item.model; 
                }
                dom.wire.value = item.parentWireNumber; 
                dom.distance.value = item.distance; 
                dom.quantity.value = item.quantity;
            }, 100);
        }

        function adicionarComponenteItem(isEditing = false) {
            const { component } = allDomElements;
            let itemType = component.type.value; 
            let selectedModel = component.model.value;
            const parentWireNumber = component.wire.value; 
            const distance = parseFloat(component.distance.value);
            const quantity = parseFloat(component.quantity.value); 
            let finalModel, finalPricePerUnit, finalUnit, isCustomType = false;
            
            if (itemType === 'custom-type') {
                finalModel = component.customName.value.trim();
                itemType = finalModel; // O tipo customizado se torna o nome do item
                finalPricePerUnit = parseFloat(component.customPrice.value);
                finalUnit = 'Unit'; // Unidade padrão para novos tipos
                isCustomType = true;
                if (!finalModel || isNaN(finalPricePerUnit) || finalPricePerUnit <= 0) { 
                    exibirMensagem("Please fill all custom Component fields for the new type.", "erro"); 
                    return; 
                }
            } else {
                const selectedComponentTypeData = componentTypesData.find(ct => ct.type === itemType);
                if (!selectedComponentTypeData) { exibirMensagem("Please select a valid Component Type.", "erro"); return; }
                
                if (selectedComponentTypeData.isDirectPrice) {
                    finalModel = selectedComponentTypeData.type; 
                    finalPricePerUnit = selectedComponentTypeData.pricePerUnit; 
                    finalUnit = selectedComponentTypeData.unit;
                } else {
                    if (selectedModel === 'custom') {
                        finalModel = component.customName.value.trim(); 
                        finalPricePerUnit = parseFloat(component.customPrice.value); 
                        finalUnit = 'Unit';
                        if (!finalModel || isNaN(finalPricePerUnit) || finalPricePerUnit <= 0) { exibirMensagem("Please fill all custom Component fields.", "erro"); return; }
                        logCustomItemToServer({ type: itemType, nome: finalModel, preco: finalPricePerUnit });
                    } else {
                        finalModel = selectedModel; 
                        const modelData = selectedComponentTypeData.models?.find(m => m.model === selectedModel);
                        if (!modelData) { exibirMensagem("Select a valid component model.", "erro"); return; }
                        finalPricePerUnit = modelData.pricePerUnit; 
                        finalUnit = modelData.unit;
                    }
                }
            }

            if (!itemType || !finalModel || !parentWireNumber || isNaN(distance) || distance < 0 || isNaN(quantity) || quantity <= 0) { exibirMensagem("Please fill all Component fields correctly.", "erro"); return; }
            const parentWire = listaItens.find(item => item.wireNumber === parentWireNumber);
            if (!parentWire) { exibirMensagem(`Source wire "${parentWireNumber}" not found.`, "erro"); return; }
            if (distance > parentWire.length) { exibirMensagem(`Distance exceeds the length of source wire.`, "erro"); return; }
            const subtotal = quantity * finalPricePerUnit;
            const novoComponente = { type: 'component', itemType, model: finalModel, parentWireNumber, distance, quantity, unit: finalUnit, pricePerUnit: finalPricePerUnit, subtotal, isCustom: (selectedModel === 'custom'), isCustomType };
            
            if (isEditing) { handleUpdateItem("Component", novoComponente); } else { lastAddedComponent = novoComponente; handleAddItem("Component", novoComponente); }
        }

        function popularFormularioConector(item) {
            const dom = allDomElements.connector;
            if (item.isCustom) { dom.model.value = "custom"; dom.model.dispatchEvent(new Event('change')); dom.customName.value = item.model; dom.customPrice.value = item.pricePerUnit; } 
            else { dom.model.value = item.model; }
            dom.wire.value = item.parentWireNumber; dom.distance.value = item.distance; dom.quantity.value = item.quantity;
        }

        function adicionarConector(isEditing = false) {
            const { connector } = allDomElements; let selectedModel = connector.model.value;
            const parentWireNumber = connector.wire.value; const distance = parseFloat(connector.distance.value);
            const quantity = parseInt(connector.quantity.value); let finalModel, finalPricePerUnit, finalUnit;
            if (selectedModel === 'custom') {
                finalModel = connector.customName.value.trim(); finalPricePerUnit = parseFloat(connector.customPrice.value); finalUnit = 'Unit';
                if (!finalModel || isNaN(finalPricePerUnit) || finalPricePerUnit <= 0) { exibirMensagem("Please fill all custom Connector fields.", "erro"); return; }
                logCustomItemToServer({ type: 'Conector', nome: finalModel, preco: finalPricePerUnit });
            } else {
                finalModel = selectedModel; const modelData = connectorModelsData.find(m => m.model === selectedModel);
                if (!modelData) { exibirMensagem("Select a valid connector model.", "erro"); return; }
                finalPricePerUnit = modelData.pricePerUnit; finalUnit = modelData.unit;
            }
            if (!finalModel || !parentWireNumber || isNaN(distance) || distance < 0 || isNaN(quantity) || quantity <= 0) { exibirMensagem("Please fill all Connector fields correctly.", "erro"); return; }
            const parentWire = listaItens.find(item => item.wireNumber === parentWireNumber);
            if (!parentWire) { exibirMensagem(`Source wire "${parentWireNumber}" not found.`, "erro"); return; }
            if (distance > parentWire.length) { exibirMensagem(`Distance exceeds the length of source wire.`, "erro"); return; }
            const subtotal = quantity * finalPricePerUnit;
            const novoConector = { type: 'connector', model: finalModel, parentWireNumber, distance, quantity, unit: finalUnit, pricePerUnit: finalPricePerUnit, subtotal, isCustom: (selectedModel === 'custom') };
            if(isEditing) { handleUpdateItem("Connector", novoConector); } else { lastAddedConnector = novoConector; handleAddItem("Connector", novoConector); }
        }

        function repeatLastComponent() { if(lastAddedComponent) { popularFormularioComponente(lastAddedComponent); allDomElements.component.formSection.scrollIntoView({behavior: 'smooth'}) } else exibirMensagem("No component to repeat", "erro"); }
        function repeatLastConnector() { if(lastAddedConnector) { popularFormularioConector(lastAddedConnector); allDomElements.connector.formSection.scrollIntoView({behavior: 'smooth'}) } else exibirMensagem("No connector to repeat", "erro"); }
        
        function preencherComponentModelSelect(selectedType) {
            const { component } = allDomElements;
            component.model.innerHTML = '<option value="" disabled selected>Select Model</option>';
            component.model.disabled = true;
            toggleCustomComponentFields();

            // Lógica da Label Dinâmica
            allDomElements.component.quantityLabel.textContent = (selectedType === 'Tape') ? 'METERS:' : 'QUANTITY:';

            if (selectedType === 'custom-type') {
                component.model.innerHTML = '<option value="N/A" selected>N/A (Custom Type)</option>';
                return;
            }

            const componentType = componentTypesData.find(ct => ct.type === selectedType);
            if (!componentType) return;
            if (componentType.isDirectPrice) {
                component.model.innerHTML = '<option value="N/A" selected>N/A (Direct Price)</option>';
            } else if (componentType.models?.length > 0) {
                componentType.models.forEach(model => component.model.add(new Option(model.model, model.model)));
                component.model.disabled = false;
                component.model.add(new Option("Other / Custom", "custom"));
            }
        }

        function toggleCustomComponentFields() {
            const { component } = allDomElements;
            const showCustom = component.model.value === 'custom' || component.type.value === 'custom-type';
            component.customFields.forEach(field => field.classList.toggle('hidden', !showCustom));
            if (!showCustom) {
                component.customName.value = "";
                component.customPrice.value = "0";
            }
        }

        function toggleCustomConnectorFields() { allDomElements.connector.customFields.forEach(field => field.classList.toggle('hidden', allDomElements.connector.model.value !== 'custom')); }
        
        function zoomIn() { zoomLevel += zoomStep; desenharRede(); }
        function zoomOut() { if (zoomLevel - zoomStep >= 0.2) { zoomLevel -= zoomStep; desenharRede(); } }
        
        function toggleCustomWireFields(wireType) {
            const dom = { main: allDomElements.mainWire, branch: allDomElements.branchWire }[wireType];
            const show = dom.insulation.value === 'Other';
            dom.customFields.forEach(field => field.classList.toggle('hidden', !show));
            dom.gauge.disabled = show; if (show) dom.gauge.value = "";
        }

        function preencherWireSelects() {
            const selects = [allDomElements.branchWire.parent, allDomElements.component.wire, allDomElements.connector.wire];
            const wires = listaItens.filter(item => item.type.includes('wire'));
            selects.forEach(s => {
                const currentVal = s.value;
                s.innerHTML = '<option value="" disabled selected>Select Wire</option>';
                if (wires.length === 0) { s.disabled = true; return; }
                s.disabled = false;
                wires.forEach(wire => s.add(new Option(`Wire ${wire.wireNumber}`, wire.wireNumber)));
                if (wires.some(w => w.wireNumber === currentVal)) s.value = currentVal;
            });
        }

        async function exportToPdf() {
            exibirMensagem("Generating PDF...", "success");
            const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4'); const margin = 15; let yOffset = margin;
            const pageWidth = pdf.internal.pageSize.getWidth(), usableWidth = pageWidth - (2 * margin);
            pdf.setFontSize(20); pdf.text("Wire Budget Report", pageWidth / 2, yOffset, { align: 'center' }); yOffset += 12;
            pdf.setFontSize(12);
            pdf.text(`Project: ${allDomElements.projetoInput.value || 'N/A'}`, margin, yOffset);
            pdf.text(`Author: ${allDomElements.autorInput.value || 'N/A'}`, margin, yOffset + 7);
            pdf.text(`Region: ${allDomElements.regiaoSelect.value || 'N/A'}`, margin, yOffset + 14); yOffset += 25;
            if (listaItens.length > 0) {
                pdf.setFontSize(16); pdf.text("Material List", margin, yOffset); yOffset += 8;
                const tableCanvas = await html2canvas(document.querySelector(".table-container"), { scale: 2 });
                const tableImgData = tableCanvas.toDataURL('image/png'); const tableImgHeight = (tableCanvas.height * usableWidth) / tableCanvas.width;
                if (yOffset + tableImgHeight > pdf.internal.pageSize.getHeight() - margin) { pdf.addPage(); yOffset = margin; }
                pdf.addImage(tableImgData, 'PNG', margin, yOffset, usableWidth, tableImgHeight); yOffset += tableImgHeight + 10;
            }
            if (yOffset + 20 > pdf.internal.pageSize.getHeight() - margin) { pdf.addPage(); yOffset = margin; }
            pdf.setFontSize(14); pdf.text(`Total Estimated Cost: ${allDomElements.totalEstimativaElement.textContent}`, margin, yOffset); yOffset += 15;
            if (listaItens.find(item => item.type === 'main-wire')) {
                if (yOffset + 80 > pdf.internal.pageSize.getHeight() - margin) { pdf.addPage(); yOffset = margin; }
                pdf.setFontSize(16); pdf.text("Wire View", margin, yOffset); yOffset += 8;
                const canvasImage = allDomElements.ramalCanvas.toDataURL('image/png', 1.0);
                const imgHeightCanvas = (allDomElements.ramalCanvas.height * usableWidth) / allDomElements.ramalCanvas.width;
                pdf.addImage(canvasImage, 'PNG', margin, yOffset, usableWidth, imgHeightCanvas);
            }
            pdf.save(`${(allDomElements.projetoInput.value || 'Report').replace(/ /g, '_')}.pdf`);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            preencherStaticSelects();
            finalizarEdicao();
            allDomElements.mainWire.insulation.addEventListener("change", () => toggleCustomWireFields('main'));
            allDomElements.branchWire.insulation.addEventListener("change", () => toggleCustomWireFields('branch'));
            allDomElements.component.type.addEventListener("change", (e) => preencherComponentModelSelect(e.target.value));
            allDomElements.component.model.addEventListener("change", toggleCustomComponentFields);
            allDomElements.connector.model.addEventListener("change", toggleCustomConnectorFields);
            allDomElements.repeatComponentButton.addEventListener("click", repeatLastComponent);
            allDomElements.repeatConnectorButton.addEventListener("click", repeatLastConnector);
            allDomElements.zoomInButton.addEventListener("click", zoomIn);
            allDomElements.zoomOutButton.addEventListener("click", zoomOut);
            allDomElements.exportPdfButton.addEventListener("click", exportToPdf);
            window.addEventListener('resize', desenharRede);
        });
    </script>
</body>
</html>